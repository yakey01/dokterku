name: Auto Deploy to Hostinger

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: 🚀 Deploy to Hostinger
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: 153.92.8.132
        username: u454362045
        password: ${{ secrets.SSH_PASSWORD }}
        port: 65002
        script: |
          cd domains/dokterkuklinik.com/public_html
          echo "🔄 Pulling latest code..."
          git pull origin main
          
          echo "🔧 Setting up production environment..."
          if [ -f ".env.hostinger" ]; then
            cp .env.hostinger .env
            echo "✅ Copied .env.hostinger to .env"
          elif [ ! -f ".env" ]; then
            echo "❌ No .env file found, creating basic one..."
            cat > .env << 'EOF'
APP_NAME="Dokterku Klinik"
APP_ENV=production
APP_DEBUG=false
APP_URL=https://dokterkuklinik.com
DB_CONNECTION=mysql
DB_HOST=localhost
DB_PORT=3306
DB_DATABASE=u454362045_klinik
DB_USERNAME=u454362045_klinik
DB_PASSWORD=LaTahzan@01
EOF
          fi
          
          echo "🔧 Trying common Hostinger database patterns..."
          
          # Test pattern 1: u454362045_klinik (most common)
          echo "Testing pattern 1: u454362045_klinik"
          if mysql -h localhost -u "u454362045_klinik" -p"LaTahzan@01" -e "SELECT 1;" 2>/dev/null; then
            echo "✅ Pattern 1 works! Using u454362045_klinik"
            sed -i 's/^DB_DATABASE=.*/DB_DATABASE=u454362045_klinik/' .env
            sed -i 's/^DB_USERNAME=.*/DB_USERNAME=u454362045_klinik/' .env
          # Test pattern 2: u454362045_dokterkuklinik
          elif mysql -h localhost -u "u454362045_dokterkuklinik" -p"LaTahzan@01" -e "SELECT 1;" 2>/dev/null; then
            echo "✅ Pattern 2 works! Using u454362045_dokterkuklinik"
            sed -i 's/^DB_DATABASE=.*/DB_DATABASE=u454362045_dokterkuklinik/' .env
            sed -i 's/^DB_USERNAME=.*/DB_USERNAME=u454362045_dokterkuklinik/' .env
          # Test pattern 3: Original specified
          elif mysql -h localhost -u "u454362045_u45436245_kli" -p"LaTahzan@01" -e "SELECT 1;" 2>/dev/null; then
            echo "✅ Pattern 3 works! Using u454362045_u45436245_kli"
            sed -i 's/^DB_DATABASE=.*/DB_DATABASE=u454362045_u45436245_kli/' .env
            sed -i 's/^DB_USERNAME=.*/DB_USERNAME=u454362045_u45436245_kli/' .env
          else
            echo "❌ No working database pattern found. Using fallback..."
            sed -i 's/^DB_DATABASE=.*/DB_DATABASE=u454362045_klinik/' .env
            sed -i 's/^DB_USERNAME=.*/DB_USERNAME=u454362045_klinik/' .env
          fi
          
          # Set common settings
          sed -i 's/^DB_HOST=.*/DB_HOST=localhost/' .env
          sed -i 's/^DB_PASSWORD=.*/DB_PASSWORD=LaTahzan@01/' .env
          sed -i 's/^DB_CONNECTION=.*/DB_CONNECTION=mysql/' .env
          sed -i 's/^DB_PORT=.*/DB_PORT=3306/' .env
          
          echo "📋 Current database config:"
          grep "^DB_" .env || echo "No DB config found"
          
          echo "🧹 Clearing config cache..."
          php artisan config:clear
          
          echo "🔌 Testing database connection..."
          php -r "
          try {
              \$pdo = new PDO('mysql:host=localhost;dbname=u454362045_u45436245_kli', 'u454362045_u45436245_kli', 'LaTahzan@01');
              echo '✅ Direct PDO connection: SUCCESS\n';
          } catch (Exception \$e) {
              echo '❌ Direct PDO connection failed: ' . \$e->getMessage() . '\n';
          }
          "
          
          echo "🔌 Testing Laravel database connection..."
          php artisan migrate:status || echo "❌ Migration status failed"
          
          echo "🗄️ Running migrations..."
          php artisan migrate --force || echo "⚠️ Migrations failed but continuing..."
          
          echo "🧹 Clearing caches..."
          php artisan cache:clear
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear
          
          echo "⚡ Optimizing..."
          php artisan optimize
          
          echo "✅ Deployment completed!"