#!/usr/bin/expect -f

set timeout 60

spawn ssh -p 65002 u454362045@153.92.8.132
expect "password:"
send "LaTahzan@01\r"
expect -re ".*\\\$.*"

send "cd /home/u454362045/domains/dokterkuklinik.com/public_html\r"
expect -re ".*\\\$.*"

# Transfer file using base64
send "echo 'PD9waHAKcmVxdWlyZV9vbmNlICd2ZW5kb3IvYXV0b2xvYWQucGhwJzsKJGFwcCA9IHJlcXVpcmVfb25jZSAnYm9vdHN0cmFwL2FwcC5waHAnOwoka2VybmVsID0gJGFwcC0+bWFrZSgnSWxsdW1pbmF0ZVxcQ29udHJhY3RzXFxDb25zb2xlXFxLZXJuZWwnKTsKJGtlcm5lbC0+Ym9vdHN0cmFwKCk7CgplY2hvICI9PT0gUEFSQU1FRElTIEZJWCA9PT0iIC4gUEhQX0VPTDsKCnRyeSB7CiAgICAvLyBHZXQgb3IgY3JlYXRlIHJvbGUKICAgICRyb2xlID0gREI6OnRhYmxlKCdyb2xlcycpLT53aGVyZSgnbmFtZScsICdwYXJhbWVkaXMnKS0+Zmlyc3QoKTsKICAgIGlmICghJHJvbGUpIHsKICAgICAgICAkcm9sZUlkID0gREI6OnRhYmxlKCdyb2xlcycpLT5pbnNlcnRHZXRJZChbCiAgICAgICAgICAgICduYW1lJyA9PiAncGFyYW1lZGlzJywKICAgICAgICAgICAgJ2Rpc3BsYXlfbmFtZScgPT4gJ1BhcmFtZWRpYycsCiAgICAgICAgICAgICdndWFyZF9uYW1lJyA9PiAnd2ViJywKICAgICAgICAgICAgJ2NyZWF0ZWRfYXQnID0+IG5vdygpLAogICAgICAgICAgICAndXBkYXRlZF9hdCcgPT4gbm93KCkKICAgICAgICBdKTsKICAgICAgICAkcm9sZSA9IChvYmplY3QpWydpZCcgPT4gJHJvbGVJZF07CiAgICAgICAgZWNobyAiQ3JlYXRlZCByb2xlOiAkcm9sZUlkIiAuIFBIUF9FT0w7CiAgICB9IGVsc2UgewogICAgICAgIGVjaG8gIlJvbGUgZXhpc3RzOiB7JHJvbGUtPmlkfSIgLiBQSFBfRU9MOwogICAgfQoKICAgIC8vIERlbGV0ZSBleGlzdGluZyB1c2VyCiAgICBEQjo6dGFibGUoJ3VzZXJzJyktPndoZXJlKCdlbWFpbCcsICd0aW5hQHBhcmFtZWRpcy5jb20nKS0+ZGVsZXRlKCk7CiAgICBlY2hvICJEZWxldGVkIGV4aXN0aW5nIHVzZXIiIC4gUEhQX0VPTDsKCiAgICAvLyBDcmVhdGUgbmV3IHVzZXIKICAgICR1c2VySWQgPSBEQjo6dGFibGUoJ3VzZXJzJyktPmluc2VydEdldElkKFsKICAgICAgICAnbmFtZScgPT4gJ1RpbmEgUGFyYW1lZGlzJywKICAgICAgICAnZW1haWwnID0+ICd0aW5hQHBhcmFtZWRpcy5jb20nLAogICAgICAgICdlbWFpbF92ZXJpZmllZF9hdCcgPT4gbm93KCksCiAgICAgICAgJ3Bhc3N3b3JkJyA9PiBIYXNoOjptYWtlKCdwYXNzd29yZDEyMycpLAogICAgICAgICdyb2xlX2lkJyA9PiAkcm9sZS0+aWQsCiAgICAgICAgJ2NyZWF0ZWRfYXQnID0+IG5vdygpLAogICAgICAgICd1cGRhdGVkX2F0JyA9PiBub3coKQogICAgXSk7CiAgICBlY2hvICJDcmVhdGVkIHVzZXI6ICR1c2VySWQiIC4gUEhQX0VPTDsKCiAgICAvLyBUZXN0IGF1dGgKICAgICRhdXRoID0gQXV0aDo6YXR0ZW1wdChbJ2VtYWlsJyA9PiAndGluYUBwYXJhbWVkaXMuY29tJywgJ3Bhc3N3b3JkJyA9PiAncGFzc3dvcmQxMjMnXSk7CiAgICBlY2hvICJBdXRoOiAiIC4gKCRhdXRoID8gJ1NVQ0NFU1MnIDogJ0ZBSUxFRCcpIC4gUEhQX0VPTDsKICAgIGlmICgkYXV0aCkgQXV0aDo6bG9nb3V0KCk7CgogICAgLy8gQ2xlYXIgY2FjaGVzCiAgICBBcnRpc2FuOjpjYWxsKCdjYWNoZTpjbGVhcicpOwogICAgQXJ0aXNhbjo6Y2FsbCgnY29uZmlnOmNsZWFyJyk7CgogICAgZWNobyAiPT09IEZJWCBDT01QTEVURSA9PT0iIC4gUEhQX0VPTDsKICAgIGVjaG8gIkxvZ2luIGF0OiAiIC4gY29uZmlnKCdhcHAudXJsJykgLiAiL3BhcmFtZWRpcy9sb2dpbiIgLiBQSFBfRU9MOwogICAgZWNobyAiRW1haWw6IHRpbmFAcGFyYW1lZGlzLmNvbSIgLiBQSFBfRU9MOwogICAgZWNobyAiUGFzc3dvcmQ6IHBhc3N3b3JkMTIzIiAuIFBIUF9FT0w7Cgp9IGNhdGNoIChFeGNlcHRpb24gJGUpIHsKICAgIGVjaG8gIkVSUk9SOiAiIC4gJGUtPmdldE1lc3NhZ2UoKSAuIFBIUF9FT0w7Cn0KPz4=' | base64 -d > paramedis_fix.php\r"
expect -re ".*\\\$.*"

send "ls -la paramedis_fix.php\r"
expect -re ".*\\\$.*"

send "php paramedis_fix.php\r"

expect {
    "*SUCCESS*" {
        puts "\n=== AUTHENTICATION SUCCESS! ==="
    }
    "*FAILED*" {
        puts "\n=== AUTHENTICATION FAILED ==="
    }
    "*FIX COMPLETE*" {
        puts "\n=== FIX COMPLETED ==="
    }
    timeout {
        puts "\n=== TIMEOUT ==="
    }
}

expect -re ".*\\\$.*"

send "echo 'Fix executed. Test at: https://dokterkuklinik.com/paramedis/login'\r"
expect -re ".*\\\$.*"

send "exit\r"
expect eof

puts "\n=== PRODUCTION FIX COMPLETED ==="