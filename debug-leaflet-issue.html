<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Leaflet Component Issue</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px;
            background: #f5f5f5; 
        }
        .debug-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .error { color: #e53e3e; }
        .success { color: #38a169; }
        .warning { color: #d69e2e; }
        pre { 
            background: #f7fafc; 
            padding: 15px; 
            border-radius: 4px; 
            overflow: auto;
            white-space: pre-wrap;
        }
        button {
            background: #3182ce;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }
        button:hover { background: #2c5282; }
        .result-box {
            background: #edf2f7;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üîç Leaflet Component Debug Tool</h1>
    
    <div class="debug-section">
        <h2>Current Issue Analysis</h2>
        <p>The test shows these functions are missing:</p>
        <ul>
            <li><code>window.leafletMapComponent</code> - ‚ùå Missing</li>
            <li><code>window.initializeMap</code> - ‚ùå Missing</li>
            <li><code>window.debugLeafletErrors</code> - ‚ùå Missing</li>
        </ul>
    </div>

    <div class="debug-section">
        <h2>üß™ Real-Time Function Check</h2>
        <button onclick="checkFunctionAvailability()">Check Function Availability</button>
        <button onclick="checkWindowObject()">Inspect Window Object</button>
        <button onclick="simulateComponentCreation()">Test Component Creation</button>
        <div id="function-check-result" class="result-box">Ready to check functions...</div>
    </div>

    <div class="debug-section">
        <h2>üîß Quick Fix Generator</h2>
        <p>Based on the analysis, here's what might be wrong and how to fix it:</p>
        <button onclick="generateFixCode()">Generate Fix Code</button>
        <div id="fix-code-result" class="result-box">Click button to generate fix...</div>
    </div>

    <div class="debug-section">
        <h2>üìã Test Commands</h2>
        <p>Copy and paste these commands in your browser console on the actual component page:</p>
        <pre id="test-commands">
// 1. Check if functions exist
console.log('leafletMapComponent:', typeof window.leafletMapComponent);
console.log('initializeMap:', typeof window.initializeMap);
console.log('debugLeafletErrors:', typeof window.debugLeafletErrors);

// 2. List all window functions starting with 'leaflet'
Object.keys(window).filter(key => key.toLowerCase().includes('leaflet'));

// 3. Check for Alpine.js
console.log('Alpine.js:', typeof Alpine);

// 4. Check for any JavaScript errors in console
console.log('Check the console for any red error messages that might prevent function registration');
        </pre>
    </div>

    <div class="debug-section">
        <h2>üí° Most Likely Causes</h2>
        <ol>
            <li><strong>JavaScript Syntax Error:</strong> A syntax error in the blade file prevents the functions from being defined</li>
            <li><strong>Template Variable Error:</strong> Laravel blade variables like <code>{{ $statePath }}</code> are causing issues</li>
            <li><strong>Execution Order:</strong> Scripts are loading in wrong order, preventing function registration</li>
            <li><strong>Scope Issues:</strong> Functions are defined in wrong scope or inside conditional blocks</li>
        </ol>
    </div>

    <script>
        function checkFunctionAvailability() {
            const result = document.getElementById('function-check-result');
            let output = 'üîç FUNCTION AVAILABILITY CHECK:\n\n';

            // Check for main functions
            const functions = [
                'leafletMapComponent',
                'initializeMap', 
                'debugLeafletErrors',
                'getCurrentLocation',
                'copyCoordinates',
                'toggleMapStyle',
                'testCoordinateFields'
            ];

            functions.forEach(funcName => {
                const exists = typeof window[funcName] === 'function';
                output += `${exists ? '‚úÖ' : '‚ùå'} window.${funcName}: ${typeof window[funcName]}\n`;
            });

            // Check for dynamic function names (with statePath)
            output += '\nüîç CHECKING DYNAMIC FUNCTION NAMES:\n';
            const dynamicFunctions = Object.keys(window).filter(key => 
                key.includes('leafletMapComponent_') || key.includes('leaflet')
            );
            
            if (dynamicFunctions.length > 0) {
                output += `Found ${dynamicFunctions.length} leaflet-related functions:\n`;
                dynamicFunctions.forEach(func => {
                    output += `  - ${func}: ${typeof window[func]}\n`;
                });
            } else {
                output += 'No dynamic leaflet functions found\n';
            }

            output += '\nüß™ ALPINE.JS CHECK:\n';
            output += `Alpine.js available: ${typeof Alpine !== 'undefined' ? '‚úÖ Yes' : '‚ùå No'}\n`;

            result.textContent = output;
        }

        function checkWindowObject() {
            const result = document.getElementById('function-check-result');
            let output = 'ü™ü WINDOW OBJECT INSPECTION:\n\n';

            // Get all window properties that might be related
            const allLeafletProps = Object.keys(window).filter(key => 
                key.toLowerCase().includes('leaflet') || 
                key.toLowerCase().includes('map') ||
                key.toLowerCase().includes('gps') ||
                key.toLowerCase().includes('location')
            );

            output += `Found ${allLeafletProps.length} potentially related properties:\n`;
            allLeafletProps.forEach(prop => {
                output += `  - ${prop}: ${typeof window[prop]}\n`;
            });

            // Check for common JavaScript libraries
            output += '\nüìö LIBRARY CHECK:\n';
            const libraries = ['L', 'Alpine', '$', 'jQuery', 'Livewire'];
            libraries.forEach(lib => {
                output += `${lib}: ${typeof window[lib] !== 'undefined' ? '‚úÖ' : '‚ùå'}\n`;
            });

            result.textContent = output;
        }

        function simulateComponentCreation() {
            const result = document.getElementById('function-check-result');
            let output = 'üèóÔ∏è COMPONENT CREATION SIMULATION:\n\n';

            try {
                // Try to create a basic leaflet component function
                output += '1. Creating basic component function...\n';
                
                window.testLeafletMapComponent = function() {
                    return {
                        mapId: 'test-map',
                        map: null,
                        marker: null,
                        initializeMap: function() {
                            console.log('Test initializeMap called');
                            return Promise.resolve('Map initialized');
                        }
                    };
                };
                
                output += '‚úÖ Basic function creation: SUCCESS\n';

                // Test the function
                output += '2. Testing function execution...\n';
                const testComponent = window.testLeafletMapComponent();
                output += `‚úÖ Function execution: SUCCESS\n`;
                output += `   - Component type: ${typeof testComponent}\n`;
                output += `   - Has initializeMap: ${typeof testComponent.initializeMap === 'function'}\n`;

                // Test Alpine.js compatibility
                output += '3. Testing Alpine.js compatibility...\n';
                if (typeof Alpine !== 'undefined') {
                    output += '‚úÖ Alpine.js available for testing\n';
                } else {
                    output += '‚ö†Ô∏è Alpine.js not available (normal in this test environment)\n';
                }

                output += '\nüí° CONCLUSION:\n';
                output += 'Basic component creation works fine.\n';
                output += 'The issue is likely in the actual blade.php file.\n';

            } catch (error) {
                output += `‚ùå Error during simulation: ${error.message}\n`;
                output += `Stack trace: ${error.stack}\n`;
            }

            result.textContent = output;
        }

        function generateFixCode() {
            const result = document.getElementById('fix-code-result');
            const fixCode = `// üîß LEAFLET COMPONENT FIX CODE
// Add this to the top of your leaflet-osm-map.blade.php file, right after opening <script> tag:

<script>
// IMMEDIATE GLOBAL FUNCTION DEFINITION - Must be before any x-data usage
(function() {
    'use strict';
    
    console.log('üöÄ Registering global leaflet functions...');
    
    // Main Alpine.js component function
    window.leafletMapComponent = function() {
        console.log('üó∫Ô∏è leafletMapComponent called');
        
        return {
            mapId: '{{ $uniqueMapId }}',
            map: null,
            marker: null,
            
            // Alpine.js lifecycle
            init() {
                console.log('üéØ Alpine init called for:', this.mapId);
                this.$nextTick(() => {
                    this.initializeMap().catch(console.error);
                });
            },
            
            async initializeMap() {
                console.log('üåç Initializing map...');
                // Your map initialization code here
                return Promise.resolve();
            }
        };
    };
    
    // Global initialize function for direct access
    window.initializeMap = function() {
        console.log('üéØ Global initializeMap called');
        // Find Alpine component and call its initializeMap method
        const element = document.querySelector('[x-data*="leafletMapComponent"]');
        if (element && element._x_dataStack) {
            const component = element._x_dataStack[0];
            if (component && typeof component.initializeMap === 'function') {
                return component.initializeMap();
            }
        }
        console.error('Could not find Alpine component');
    };
    
    // Debug function
    window.debugLeafletErrors = function() {
        console.log('üêõ Running debug check...');
        return {
            leafletMapComponent: typeof window.leafletMapComponent === 'function',
            initializeMap: typeof window.initializeMap === 'function',
            alpine: typeof Alpine !== 'undefined'
        };
    };
    
    console.log('‚úÖ Global functions registered successfully');
})();
</script>

// üìù USAGE:
// 1. Replace your current function definitions with the above code
// 2. Make sure this script runs BEFORE the div with x-data="leafletMapComponent()"
// 3. Test with: debugLeafletErrors() in browser console`;

            result.textContent = fixCode;
        }

        // Auto-run initial check
        window.addEventListener('DOMContentLoaded', () => {
            checkFunctionAvailability();
        });
    </script>
</body>
</html>