<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React Component Tree Analyzer</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-panel {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }
        
        .control-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        button.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        button.success {
            background: linear-gradient(135deg, #26de81 0%, #20bf6b 100%);
        }
        
        button.warning {
            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
        }
        
        .analysis-results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .analysis-results {
                grid-template-columns: 1fr;
            }
        }
        
        .result-section {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .result-section h3 {
            color: #2d3748;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .detection-item {
            background: #f7fafc;
            border-left: 4px solid #4299e1;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 6px 6px 0;
        }
        
        .detection-item.high-risk {
            border-left-color: #e53e3e;
            background: #fed7d7;
        }
        
        .detection-item.medium-risk {
            border-left-color: #d69e2e;
            background: #faf089;
        }
        
        .detection-item.low-risk {
            border-left-color: #38a169;
            background: #c6f6d5;
        }
        
        .code-block {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        .object-preview {
            background: #2d3748;
            color: #90cdf4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8em;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .log-console {
            background: #1a202c;
            color: #e2e8f0;
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9em;
            margin-top: 20px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active { background: #38a169; }
        .status-warning { background: #d69e2e; }
        .status-error { background: #e53e3e; }
        .status-inactive { background: #718096; }
        
        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .filter-tab {
            padding: 8px 16px;
            background: #e2e8f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .filter-tab.active {
            background: #4299e1;
            color: white;
        }
        
        .component-path {
            font-family: monospace;
            background: #f7fafc;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            color: #4a5568;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç React Component Tree Analyzer</h1>
        
        <div class="control-panel">
            <div class="control-group">
                <button onclick="startAnalysis()" class="success">
                    üöÄ Start Analysis
                </button>
                <button onclick="stopAnalysis()" class="danger">
                    üõë Stop Analysis
                </button>
                <button onclick="clearResults()" class="warning">
                    üßπ Clear Results
                </button>
                <button onclick="exportResults()">
                    üíæ Export Results
                </button>
                <button onclick="injectDetectionScript()">
                    üíâ Inject Detection Script
                </button>
            </div>
            
            <div class="control-group">
                <button onclick="analyzeCurrentDOM()">
                    üåê Analyze Current DOM
                </button>
                <button onclick="findJadwalObjects()">
                    üéØ Find Jadwal Objects
                </button>
                <button onclick="testReactRender()">
                    üß™ Test React Render
                </button>
                <button onclick="simulateError()">
                    ‚ö†Ô∏è Simulate Object Error
                </button>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalDetections">0</div>
                <div class="stat-label">Total Detections</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="highRiskCount">0</div>
                <div class="stat-label">High Risk Issues</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="objectChildren">0</div>
                <div class="stat-label">Object Children</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="domObjects">0</div>
                <div class="stat-label">DOM Objects Found</div>
            </div>
        </div>
        
        <div class="analysis-results">
            <div class="result-section">
                <h3>üö® Object Detection Log</h3>
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="filterDetections('all')">All</button>
                    <button class="filter-tab" onclick="filterDetections('HIGH')">High Risk</button>
                    <button class="filter-tab" onclick="filterDetections('MEDIUM')">Medium Risk</button>
                    <button class="filter-tab" onclick="filterDetections('CONSOLE_ERROR')">Errors</button>
                </div>
                <div id="detectionResults"></div>
            </div>
            
            <div class="result-section">
                <h3>üå≥ Component Tree Analysis</h3>
                <div id="componentTree"></div>
            </div>
        </div>
        
        <div class="result-section">
            <h3>üìä Live Analysis Console</h3>
            <div id="analysisConsole" class="log-console"></div>
        </div>
    </div>

    <script>
        class ComponentTreeAnalyzer {
            constructor() {
                this.isAnalyzing = false;
                this.detectionLog = [];
                this.componentTree = new Map();
                this.filter = 'all';
                this.console = document.getElementById('analysisConsole');
                
                this.setupConsoleOverride();
                this.setupReactInterception();
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `<span style="color: #90cdf4;">[${timestamp}]</span> ${message}`;
                this.console.appendChild(logEntry);
                this.console.scrollTop = this.console.scrollHeight;
                
                // Keep console manageable
                if (this.console.children.length > 1000) {
                    this.console.removeChild(this.console.firstChild);
                }
            }
            
            setupConsoleOverride() {
                const originalError = console.error;
                console.error = (...args) => {
                    originalError(...args);
                    
                    const message = args.join(' ');
                    if (message.includes('Objects are not valid as React child')) {
                        this.handleObjectError(message, args);
                    }
                };
            }
            
            setupReactInterception() {
                if (typeof window !== 'undefined' && window.React) {
                    const originalCreateElement = window.React.createElement;
                    
                    window.React.createElement = (type, props, ...children) => {
                        if (this.isAnalyzing) {
                            this.analyzeElement(type, props, children);
                        }
                        return originalCreateElement(type, props, ...children);
                    };
                    
                    this.log('‚úÖ React.createElement intercepted', 'success');
                }
            }
            
            analyzeElement(type, props, children) {
                const componentName = typeof type === 'string' ? type : (type?.name || 'Anonymous');
                
                // Check props for objects
                if (props) {
                    Object.entries(props).forEach(([key, value]) => {
                        if (this.isInvalidReactChild(value)) {
                            this.addDetection({
                                type: 'PROP_OBJECT',
                                component: componentName,
                                prop: key,
                                value: this.safeStringify(value),
                                severity: this.assessSeverity(value),
                                timestamp: Date.now(),
                                stackTrace: new Error().stack
                            });
                        }
                    });
                }
                
                // Check children for objects
                children.forEach((child, index) => {
                    if (this.isInvalidReactChild(child)) {
                        this.addDetection({
                            type: 'CHILD_OBJECT',
                            component: componentName,
                            location: `child[${index}]`,
                            value: this.safeStringify(child),
                            severity: this.assessSeverity(child),
                            timestamp: Date.now(),
                            stackTrace: new Error().stack
                        });
                    }
                });
            }
            
            isInvalidReactChild(value) {
                return (
                    value !== null &&
                    value !== undefined &&
                    typeof value === 'object' &&
                    !React.isValidElement(value) &&
                    !Array.isArray(value) &&
                    typeof value !== 'string' &&
                    typeof value !== 'number' &&
                    typeof value !== 'boolean'
                );
            }
            
            assessSeverity(obj) {
                if (obj && typeof obj === 'object') {
                    // High severity for jadwal objects
                    if (obj.hasOwnProperty('jadwal') || 
                        obj.hasOwnProperty('tanggal_jaga') ||
                        obj.hasOwnProperty('shift_template')) {
                        return 'HIGH';
                    }
                    
                    // Medium for plain objects
                    if (obj.constructor === Object) {
                        return 'MEDIUM';
                    }
                }
                
                return 'LOW';
            }
            
            safeStringify(obj) {
                try {
                    if (obj === null || obj === undefined) return String(obj);
                    if (typeof obj !== 'object') return String(obj);
                    
                    // Handle circular references
                    const cache = new Set();
                    return JSON.stringify(obj, (key, value) => {
                        if (typeof value === 'object' && value !== null) {
                            if (cache.has(value)) return '[Circular]';
                            cache.add(value);
                        }
                        return value;
                    }, 2);
                } catch (e) {
                    return `[Unstringifiable: ${e.message}]`;
                }
            }
            
            addDetection(detection) {
                this.detectionLog.push(detection);
                
                this.log(`üö® ${detection.severity} - ${detection.type} in ${detection.component}`, 'error');
                
                if (detection.severity === 'HIGH') {
                    this.log(`‚ö†Ô∏è HIGH SEVERITY OBJECT: ${detection.value}`, 'error');
                }
                
                this.updateStats();
                this.renderDetections();
            }
            
            handleObjectError(message, args) {
                this.addDetection({
                    type: 'CONSOLE_ERROR',
                    message,
                    args: args.map(arg => this.safeStringify(arg)),
                    severity: 'HIGH',
                    timestamp: Date.now(),
                    stackTrace: new Error().stack
                });
            }
            
            updateStats() {
                document.getElementById('totalDetections').textContent = this.detectionLog.length;
                document.getElementById('highRiskCount').textContent = 
                    this.detectionLog.filter(d => d.severity === 'HIGH').length;
                document.getElementById('objectChildren').textContent = 
                    this.detectionLog.filter(d => d.type === 'CHILD_OBJECT').length;
            }
            
            renderDetections() {
                const container = document.getElementById('detectionResults');
                
                const filtered = this.filter === 'all' ? 
                    this.detectionLog : 
                    this.detectionLog.filter(d => d.severity === this.filter || d.type === this.filter);
                
                container.innerHTML = filtered.slice(-20).map(detection => {
                    const riskClass = detection.severity ? detection.severity.toLowerCase() + '-risk' : 'low-risk';
                    
                    return `
                        <div class="detection-item ${riskClass}">
                            <div><span class="status-indicator status-${detection.severity === 'HIGH' ? 'error' : 'warning'}"></span>
                            <strong>${detection.type}</strong> - ${detection.component || 'Unknown'}</div>
                            ${detection.prop ? `<div class="component-path">Prop: ${detection.prop}</div>` : ''}
                            ${detection.location ? `<div class="component-path">Location: ${detection.location}</div>` : ''}
                            <div class="object-preview">${detection.value || detection.message || 'No value'}</div>
                            <small>Severity: ${detection.severity} | Time: ${new Date(detection.timestamp).toLocaleTimeString()}</small>
                        </div>
                    `;
                }).join('');
            }
            
            analyzeDOM() {
                this.log('üîç Starting DOM analysis...', 'info');
                
                const walker = document.createTreeWalker(
                    document.body,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                let count = 0;
                let node;
                
                while (node = walker.nextNode()) {
                    const text = node.textContent || '';
                    if (text.includes('[object Object]')) {
                        count++;
                        this.addDetection({
                            type: 'DOM_OBJECT',
                            component: node.parentElement?.tagName || 'Unknown',
                            value: text,
                            severity: 'HIGH',
                            timestamp: Date.now()
                        });
                    }
                }
                
                document.getElementById('domObjects').textContent = count;
                this.log(`üìä DOM analysis complete. Found ${count} object texts.`, 'info');
            }
            
            findJadwalInMemory() {
                this.log('üéØ Searching for jadwal objects in memory...', 'info');
                
                let found = 0;
                
                // Check window properties
                for (let key in window) {
                    try {
                        const value = window[key];
                        if (this.containsJadwal(value)) {
                            found++;
                            this.log(`Found jadwal in window.${key}`, 'warning');
                        }
                    } catch (e) {
                        // Skip inaccessible properties
                    }
                }
                
                this.log(`üéØ Memory search complete. Found ${found} jadwal objects.`, 'info');
            }
            
            containsJadwal(obj, depth = 0) {
                if (depth > 3) return false;
                
                try {
                    if (obj && typeof obj === 'object') {
                        if (obj.hasOwnProperty('jadwal') || 
                            obj.hasOwnProperty('tanggal_jaga') ||
                            obj.hasOwnProperty('shift_template')) {
                            return true;
                        }
                        
                        for (let key in obj) {
                            if (key.toLowerCase().includes('jadwal')) {
                                return true;
                            }
                            if (typeof obj[key] === 'object' && this.containsJadwal(obj[key], depth + 1)) {
                                return true;
                            }
                        }
                    }
                } catch (e) {
                    // Handle circular references
                }
                
                return false;
            }
            
            simulateObjectError() {
                this.log('‚ö†Ô∏è Simulating object rendering error...', 'warning');
                
                // Create a fake jadwal object
                const fakeJadwal = {
                    id: 1,
                    tanggal_jaga: '2024-01-01',
                    shift_template: {
                        nama_shift: 'Pagi',
                        jam_masuk: '08:00',
                        jam_pulang: '16:00'
                    }
                };
                
                // Simulate the error
                this.addDetection({
                    type: 'SIMULATED_ERROR',
                    component: 'TestComponent',
                    value: this.safeStringify(fakeJadwal),
                    severity: 'HIGH',
                    timestamp: Date.now(),
                    stackTrace: 'Simulated error for testing'
                });
                
                this.log('‚ö†Ô∏è Simulation complete - check detection log', 'warning');
            }
            
            exportResults() {
                const report = {
                    timestamp: new Date().toISOString(),
                    summary: {
                        totalDetections: this.detectionLog.length,
                        highRisk: this.detectionLog.filter(d => d.severity === 'HIGH').length,
                        mediumRisk: this.detectionLog.filter(d => d.severity === 'MEDIUM').length,
                        consoleErrors: this.detectionLog.filter(d => d.type === 'CONSOLE_ERROR').length
                    },
                    detections: this.detectionLog
                };
                
                const blob = new Blob([JSON.stringify(report, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `react-debug-report-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.log('üíæ Report exported successfully', 'success');
            }
        }
        
        // Global analyzer instance
        const analyzer = new ComponentTreeAnalyzer();
        
        // Global functions for buttons
        function startAnalysis() {
            analyzer.isAnalyzing = true;
            analyzer.log('üöÄ Analysis started', 'success');
        }
        
        function stopAnalysis() {
            analyzer.isAnalyzing = false;
            analyzer.log('üõë Analysis stopped', 'warning');
        }
        
        function clearResults() {
            analyzer.detectionLog = [];
            analyzer.updateStats();
            analyzer.renderDetections();
            analyzer.console.innerHTML = '';
            analyzer.log('üßπ Results cleared', 'info');
        }
        
        function exportResults() {
            analyzer.exportResults();
        }
        
        function analyzeCurrentDOM() {
            analyzer.analyzeDOM();
        }
        
        function findJadwalObjects() {
            analyzer.findJadwalInMemory();
        }
        
        function testReactRender() {
            if (window.React) {
                analyzer.log('üß™ Testing React render with object...', 'info');
                
                try {
                    const testObj = { test: 'object', nested: { value: 123 } };
                    const element = React.createElement('div', {}, testObj);
                    analyzer.log('‚ö†Ô∏è Test object passed to React.createElement', 'warning');
                } catch (error) {
                    analyzer.log(`‚ùå React render test failed: ${error.message}`, 'error');
                }
            } else {
                analyzer.log('‚ùå React not found in window', 'error');
            }
        }
        
        function simulateError() {
            analyzer.simulateObjectError();
        }
        
        function injectDetectionScript() {
            // Inject the runtime debugging script
            const script = document.createElement('script');
            script.src = '/debug-runtime-injection.js';
            script.onload = () => {
                analyzer.log('üíâ Detection script injected successfully', 'success');
            };
            script.onerror = () => {
                analyzer.log('‚ùå Failed to inject detection script', 'error');
            };
            document.head.appendChild(script);
        }
        
        function filterDetections(filter) {
            analyzer.filter = filter;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            analyzer.renderDetections();
        }
        
        // Auto-start analysis
        analyzer.log('üîç Component Tree Analyzer initialized', 'success');
        analyzer.log('Click "Start Analysis" to begin monitoring React renders', 'info');
        
        // Check for React
        if (typeof window !== 'undefined' && window.React) {
            analyzer.log('‚úÖ React detected in window', 'success');
        } else {
            analyzer.log('‚ö†Ô∏è React not found - some features may not work', 'warning');
        }
    </script>
</body>
</html>