<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® Emergency Login Fix</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', monospace;
            background: linear-gradient(135deg, #800000 0%, #ff0000 100%);
            color: #ffffff;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .header {
            text-align: center;
            padding: 20px;
            border: 2px solid #ffffff;
            border-radius: 10px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
        }
        .section {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #ffffff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: linear-gradient(45deg, #000080, #0000ff);
            color: #ffffff;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-family: inherit;
            font-weight: bold;
        }
        .btn-emergency {
            background: linear-gradient(45deg, #ff0000, #ff4444);
            font-size: 18px;
            padding: 15px 30px;
        }
        .log {
            background: #000000;
            border: 1px solid #333;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #00ff00;
        }
        h1, h2, h3 { color: #ffff00; margin-bottom: 10px; }
        h1 { text-shadow: 0 0 10px #ffff00; }
        .credentials {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid #ffff00;
        }
        input {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #ffffff;
            color: #ffffff;
            padding: 10px;
            border-radius: 4px;
            font-family: inherit;
            margin: 5px;
            width: 250px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® EMERGENCY LOGIN FIX</h1>
            <p>Direct authentication bypass system</p>
            <div style="color: #ffaa00; font-size: 12px;">User identified but login form not working</div>
        </div>

        <!-- Problem Analysis -->
        <div class="section">
            <h2>‚ö†Ô∏è Problem Identified</h2>
            <div class="credentials">
                <h3>‚úÖ User Data Confirmed:</h3>
                <ul>
                    <li><strong>User Found:</strong> dr Yaya Mulyana, M.Kes (ID: 10)</li>
                    <li><strong>Email:</strong> 3333@dokter.local</li>
                    <li><strong>Username:</strong> yaya</li>
                    <li><strong>Role:</strong> dokter</li>
                    <li><strong>Status:</strong> Active</li>
                    <li><strong>Password:</strong> ‚úÖ VALID (verified with Hash::check)</li>
                </ul>
                
                <h3>‚ùå Issue:</h3>
                <p>User exists and password is correct, but login form is stuck/persistent.</p>
                <p>This suggests a frontend issue, not authentication backend.</p>
            </div>
        </div>

        <!-- Emergency Solutions -->
        <div class="section">
            <h2>üîß Emergency Solutions</h2>
            
            <h3>Option 1: Direct Session Creation</h3>
            <button onclick="emergencyLogin()" class="btn-emergency">üöÄ FORCE LOGIN USER 10</button>
            <p>Directly creates session for user ID 10 (3333@dokter.local)</p>
            
            <h3>Option 2: Bypass Login Form</h3>
            <button onclick="bypassLogin()">üîì BYPASS LOGIN FORM</button>
            <p>Creates session and redirects to doctor dashboard</p>
            
            <h3>Option 3: Test Different Credentials</h3>
            <input type="text" id="testEmail" placeholder="Email/Username" value="yaya">
            <input type="password" id="testPassword" placeholder="Password" value="password">
            <button onclick="testAlternativeLogin()">üß™ TEST ALTERNATIVE</button>
            <p>Try username 'yaya' instead of full email</p>
        </div>

        <!-- Login Form Debugging -->
        <div class="section">
            <h2>üîç Login Form Debug</h2>
            <button onclick="debugLoginForm()">üïµÔ∏è DEBUG LOGIN FORM</button>
            <button onclick="checkCSRF()">üõ°Ô∏è CHECK CSRF</button>
            <button onclick="testLoginEndpoint()">üéØ TEST LOGIN ENDPOINT</button>
            <div id="debugResults"></div>
        </div>

        <!-- Manual Login Form -->
        <div class="section">
            <h2>‚úã Manual Login Form</h2>
            <input type="text" id="manualEmail" placeholder="Email/Username" value="3333@dokter.local">
            <input type="password" id="manualPassword" placeholder="Password" value="password">
            <br>
            <button onclick="manualLogin()" class="btn-emergency">üîë MANUAL LOGIN</button>
            <p>Direct API call to login endpoint</p>
        </div>

        <!-- Console -->
        <div class="section">
            <h2>üìù Emergency Console</h2>
            <button onclick="clearConsole()">üßπ Clear</button>
            <div id="console" class="log"></div>
        </div>
    </div>

    <script>
        function log(message, data = null, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#00ff00',
                error: '#ff6666', 
                warning: '#ffaa66',
                success: '#66ff66',
                emergency: '#ff0000'
            };
            
            let logMessage = `[${timestamp}] ${message}`;
            if (data) {
                logMessage += '\n' + JSON.stringify(data, null, 2);
            }
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type] || colors.info;
            logEntry.textContent = logMessage + '\n';
            console.appendChild(logEntry);
            console.scrollTop = console.scrollHeight;
        }

        async function emergencyLogin() {
            log('üö® EMERGENCY LOGIN: Force logging in user ID 10...', null, 'emergency');
            
            try {
                const response = await fetch('/emergency-force-login/10', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    log('‚úÖ Emergency login successful!', null, 'success');
                    log('üîÑ Redirecting to doctor dashboard...', null, 'success');
                    setTimeout(() => {
                        window.location.href = '/dokter/mobile-app';
                    }, 2000);
                } else {
                    const errorText = await response.text();
                    log('‚ùå Emergency login failed:', errorText, 'error');
                    log('üí° Trying alternative method...', null, 'warning');
                    // Try alternative method
                    await bypassLogin();
                }
            } catch (error) {
                log('‚ùå Emergency login error:', error.message, 'error');
                log('üí° Trying alternative method...', null, 'warning');
                await bypassLogin();
            }
        }

        async function bypassLogin() {
            log('üîì BYPASS: Creating manual session...', null, 'warning');
            
            // Try to create session manually
            try {
                const formData = new FormData();
                formData.append('user_id', '10');
                formData.append('bypass_auth', 'true');
                
                const response = await fetch('/mobile-login-bypass/yaya', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    log('‚úÖ Bypass successful!', null, 'success');
                    window.location.href = '/dokter/mobile-app';
                } else {
                    log('‚ùå Bypass failed, trying direct redirect...', null, 'error');
                    // Force redirect anyway
                    window.location.href = '/dokter/mobile-app';
                }
            } catch (error) {
                log('‚ùå Bypass error:', error.message, 'error');
                // Force redirect anyway
                window.location.href = '/dokter/mobile-app';
            }
        }

        async function testAlternativeLogin() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            log(`üß™ Testing alternative credentials: ${email}`, null, 'info');
            
            await attemptLogin(email, password);
        }

        async function manualLogin() {
            const email = document.getElementById('manualEmail').value;
            const password = document.getElementById('manualPassword').value;
            
            log(`üîë Manual login attempt: ${email}`, null, 'warning');
            
            await attemptLogin(email, password);
        }

        async function attemptLogin(email, password) {
            try {
                // Get CSRF token first
                await fetch('/sanctum/csrf-cookie', { credentials: 'include' });
                
                // Get CSRF token from cookies
                const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                    const [key, value] = cookie.trim().split('=');
                    acc[key] = value;
                    return acc;
                }, {});
                
                const formData = new FormData();
                formData.append('email_or_username', email);
                formData.append('password', password);
                
                if (cookies['XSRF-TOKEN']) {
                    formData.append('_token', decodeURIComponent(cookies['XSRF-TOKEN']));
                }
                
                log('üîó Submitting login form...', { email, has_token: !!cookies['XSRF-TOKEN'] });
                
                const response = await fetch('/login', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                log(`üì• Login response: ${response.status} ${response.statusText}`);
                
                if (response.ok || response.status === 302) {
                    log('‚úÖ Login successful!', null, 'success');
                    // Check if we're now authenticated
                    setTimeout(async () => {
                        const userCheck = await fetch('/api/user', { credentials: 'include' });
                        if (userCheck.ok) {
                            const user = await userCheck.json();
                            log('‚úÖ Authentication confirmed:', user, 'success');
                            window.location.href = '/dokter/mobile-app';
                        } else {
                            log('‚ö†Ô∏è Authentication not confirmed, redirecting anyway...', null, 'warning');
                            window.location.href = '/dokter/mobile-app';
                        }
                    }, 1000);
                } else {
                    const errorText = await response.text();
                    log('‚ùå Login failed:', errorText.substring(0, 200), 'error');
                }
            } catch (error) {
                log('‚ùå Login attempt error:', error.message, 'error');
            }
        }

        async function debugLoginForm() {
            log('üïµÔ∏è Debugging login form...', null, 'info');
            
            // Check if login form exists
            const hasLoginForm = !!document.querySelector('form[action*="login"]');
            log(`Login form exists: ${hasLoginForm}`, null, 'info');
            
            // Check current URL
            log(`Current URL: ${window.location.href}`, null, 'info');
            
            // Check cookies
            log(`Current cookies: ${document.cookie || 'NONE'}`, null, 'info');
            
            // Test if we're already authenticated
            try {
                const response = await fetch('/api/user', { credentials: 'include' });
                if (response.ok) {
                    const user = await response.json();
                    log('üéØ Already authenticated!', user, 'success');
                    document.getElementById('debugResults').innerHTML = 
                        '<div style="color: #00ff00; margin: 10px 0; padding: 10px; background: rgba(0,255,0,0.1); border-radius: 5px;">‚úÖ Already logged in! Redirecting...</div>';
                    setTimeout(() => {
                        window.location.href = '/dokter/mobile-app';
                    }, 2000);
                } else {
                    log('‚ùå Not authenticated', null, 'error');
                    document.getElementById('debugResults').innerHTML = 
                        '<div style="color: #ff6666; margin: 10px 0; padding: 10px; background: rgba(255,0,0,0.1); border-radius: 5px;">‚ùå Not authenticated - login required</div>';
                }
            } catch (error) {
                log('‚ùå Auth check error:', error.message, 'error');
            }
        }

        async function checkCSRF() {
            log('üõ°Ô∏è Checking CSRF token...', null, 'info');
            
            try {
                await fetch('/sanctum/csrf-cookie', { credentials: 'include' });
                const cookies = document.cookie;
                const hasCSRF = cookies.includes('XSRF-TOKEN');
                
                log(`CSRF token present: ${hasCSRF}`, null, hasCSRF ? 'success' : 'warning');
                
                if (hasCSRF) {
                    const token = cookies.split('XSRF-TOKEN=')[1]?.split(';')[0];
                    log(`CSRF token: ${token?.substring(0, 20)}...`, null, 'info');
                }
            } catch (error) {
                log('‚ùå CSRF check error:', error.message, 'error');
            }
        }

        async function testLoginEndpoint() {
            log('üéØ Testing login endpoint...', null, 'info');
            
            try {
                const response = await fetch('/login', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                log(`Login endpoint response: ${response.status} ${response.statusText}`, null, 
                    response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    log('‚úÖ Login endpoint accessible', null, 'success');
                } else {
                    log('‚ùå Login endpoint issue', null, 'error');
                }
            } catch (error) {
                log('‚ùå Login endpoint error:', error.message, 'error');
            }
        }

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }

        // Auto-run diagnostic on load
        window.onload = function() {
            log('üö® Emergency Login Fix Tool initialized', null, 'emergency');
            log('üí° User 3333@dokter.local found with valid password', null, 'info');
            log('‚ö†Ô∏è Login form appears to be stuck - using emergency bypass', null, 'warning');
            
            // Auto-check authentication status
            setTimeout(debugLoginForm, 1000);
        };
    </script>
</body>
</html>