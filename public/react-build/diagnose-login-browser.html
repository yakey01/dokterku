<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Login Diagnostic</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="max-w-6xl mx-auto p-8">
        <h1 class="text-3xl font-bold mb-8">üåê Browser Login Diagnostic</h1>
        
        <!-- Environment Check -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Environment Check</h2>
            <div id="envCheck" class="space-y-2 text-sm"></div>
        </div>
        
        <!-- Cookie Analysis -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Cookie Analysis</h2>
            <div id="cookieAnalysis" class="space-y-2 text-sm font-mono"></div>
        </div>
        
        <!-- Quick Tests -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Quick Tests</h2>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="testDirectLogin('admin@dokterku.com')" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    Test Admin Login ‚Üí /admin
                </button>
                <button onclick="testDirectLogin('naning@dokterku.com')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Test Paramedis Login ‚Üí /paramedis
                </button>
                <button onclick="testDirectLogin('3333@dokter.local')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Test Dokter Login ‚Üí /dokter
                </button>
                <button onclick="clearAllData()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    Clear All Cookies & Storage
                </button>
            </div>
        </div>
        
        <!-- Test Results -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div id="results" class="space-y-2 text-sm font-mono overflow-y-auto max-h-96"></div>
        </div>
    </div>
    
    <script>
        // Check environment on load
        window.onload = () => {
            checkEnvironment();
            analyzeCookies();
        };
        
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-600' : 
                         type === 'success' ? 'text-green-600' : 
                         type === 'warning' ? 'text-yellow-600' : 'text-gray-600';
            
            const resultsDiv = document.getElementById('results');
            const entry = document.createElement('div');
            entry.className = color;
            entry.textContent = `[${time}] ${message}`;
            resultsDiv.appendChild(entry);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        function checkEnvironment() {
            const envDiv = document.getElementById('envCheck');
            const checks = [];
            
            // Check URL
            checks.push(`URL: ${window.location.href}`);
            checks.push(`Origin: ${window.location.origin}`);
            
            // Check browser
            checks.push(`User Agent: ${navigator.userAgent.substring(0, 50)}...`);
            
            // Check cookies enabled
            checks.push(`Cookies Enabled: ${navigator.cookieEnabled ? '‚úÖ Yes' : '‚ùå No'}`);
            
            // Check local storage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                checks.push('Local Storage: ‚úÖ Working');
            } catch(e) {
                checks.push('Local Storage: ‚ùå Not Working');
            }
            
            // Check session storage
            try {
                sessionStorage.setItem('test', 'test');
                sessionStorage.removeItem('test');
                checks.push('Session Storage: ‚úÖ Working');
            } catch(e) {
                checks.push('Session Storage: ‚ùå Not Working');
            }
            
            envDiv.innerHTML = checks.map(c => `<div>${c}</div>`).join('');
        }
        
        function analyzeCookies() {
            const cookieDiv = document.getElementById('cookieAnalysis');
            const cookies = document.cookie.split(';').map(c => c.trim()).filter(c => c);
            
            if (cookies.length === 0) {
                cookieDiv.innerHTML = '<div class="text-red-600">‚ùå No cookies found</div>';
                return;
            }
            
            const cookieInfo = cookies.map(cookie => {
                const [name, value] = cookie.split('=');
                const truncatedValue = value && value.length > 20 ? value.substring(0, 20) + '...' : value;
                return `${name} = ${truncatedValue}`;
            });
            
            cookieDiv.innerHTML = cookieInfo.map(c => `<div>${c}</div>`).join('');
            
            // Check for important cookies
            const hasSession = cookies.some(c => c.includes('laravel_session'));
            const hasXSRF = cookies.some(c => c.includes('XSRF-TOKEN'));
            
            cookieDiv.innerHTML += `<div class="mt-4">`;
            cookieDiv.innerHTML += `<div>Laravel Session: ${hasSession ? '‚úÖ Found' : '‚ùå Missing'}</div>`;
            cookieDiv.innerHTML += `<div>XSRF Token: ${hasXSRF ? '‚úÖ Found' : '‚ùå Missing'}</div>`;
            cookieDiv.innerHTML += `</div>`;
        }
        
        function getCsrfToken() {
            const match = document.cookie.match(/XSRF-TOKEN=([^;]+)/);
            if (match) return decodeURIComponent(match[1]);
            return '';
        }
        
        async function testDirectLogin(username) {
            log(`üîê Testing direct login for: ${username}`, 'info');
            
            // Clear previous results
            document.getElementById('results').innerHTML = '';
            
            try {
                // Step 1: Get CSRF token
                log('Step 1: Getting CSRF token...', 'info');
                let csrfToken = getCsrfToken();
                
                if (!csrfToken) {
                    log('No CSRF token found, fetching from server...', 'warning');
                    await fetch('/sanctum/csrf-cookie', { credentials: 'include' });
                    csrfToken = getCsrfToken();
                    
                    if (!csrfToken) {
                        log('‚ùå Failed to get CSRF token', 'error');
                        return;
                    }
                }
                
                log(`‚úÖ CSRF token: ${csrfToken.substring(0, 20)}...`, 'success');
                
                // Step 2: Perform login
                log('Step 2: Performing login...', 'info');
                
                const loginResponse = await fetch('/api/v2/auth/unified-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        login: username,
                        password: 'password',
                        device_id: `browser-test-${Date.now()}`,
                        device_name: 'Browser Test',
                        device_type: 'desktop',
                        client_type: 'web_app'
                    })
                });
                
                const loginData = await loginResponse.json();
                
                if (!loginData.success) {
                    log(`‚ùå Login failed: ${loginData.message}`, 'error');
                    return;
                }
                
                log(`‚úÖ Login successful!`, 'success');
                log(`User: ${loginData.data.user.name} (${loginData.data.user.role})`, 'success');
                log(`Redirect URL: ${loginData.data.redirect_url}`, 'info');
                
                // Step 3: Check session
                log('Step 3: Verifying session...', 'info');
                
                const sessionResponse = await fetch('/api/v2/auth/session-status', {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const sessionData = await sessionResponse.json();
                
                if (sessionData.success && sessionData.data.authenticated) {
                    log('‚úÖ Session verified!', 'success');
                } else {
                    log('‚ùå Session not established', 'error');
                }
                
                // Step 4: Analyze cookies after login
                log('Step 4: Analyzing cookies after login...', 'info');
                analyzeCookies();
                
                // Step 5: Test redirect
                log('Step 5: Testing redirect...', 'info');
                log(`Redirecting to: ${loginData.data.redirect_url}`, 'info');
                
                setTimeout(() => {
                    log('üîÑ Redirecting now...', 'success');
                    window.location.href = loginData.data.redirect_url;
                }, 3000);
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        function clearAllData() {
            if (!confirm('This will clear all cookies and storage. Continue?')) return;
            
            // Clear cookies
            document.cookie.split(";").forEach(c => {
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
            });
            
            // Clear storage
            localStorage.clear();
            sessionStorage.clear();
            
            log('‚úÖ All cookies and storage cleared', 'success');
            
            // Refresh environment check
            setTimeout(() => {
                checkEnvironment();
                analyzeCookies();
            }, 500);
        }
    </script>
</body>
</html>