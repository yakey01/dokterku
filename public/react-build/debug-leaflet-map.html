<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Leaflet Map Loading</title>
    <!-- Load Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 20px;
        }
        .debug-section {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        #debug-map {
            height: 400px;
            width: 100%;
            border: 2px solid #fff;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        .success { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .error { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .info { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
        button {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #2563EB; }
    </style>
</head>
<body>
    <h1>üîç Debug Leaflet Map Loading</h1>
    <p>Testing Leaflet map initialization to diagnose why map doesn't appear in dokter presensi.</p>

    <div class="debug-section">
        <h2>üìä Diagnostic Information</h2>
        <div id="diagnostics"></div>
    </div>

    <div class="debug-section">
        <h2>üó∫Ô∏è Test Map</h2>
        <div id="debug-map"></div>
        <button onclick="initTestMap()">Initialize Test Map</button>
        <button onclick="testGPS()">Test GPS</button>
    </div>

    <div class="debug-section">
        <h2>üîß Solutions</h2>
        <div id="solutions"></div>
    </div>

    <!-- Load Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        let debugMap = null;
        
        function updateDiagnostics() {
            const diagnostics = document.getElementById('diagnostics');
            
            let html = '<div class="status info">';
            html += '<strong>Browser Support:</strong><br>';
            html += `- Geolocation: ${navigator.geolocation ? '‚úÖ Supported' : '‚ùå Not Supported'}<br>`;
            html += `- Leaflet Library: ${window.L ? '‚úÖ Loaded' : '‚ùå Not Loaded'}<br>`;
            html += `- CSS Applied: ${getComputedStyle(document.body).fontFamily ? '‚úÖ Styles Active' : '‚ùå No Styles'}<br>`;
            html += '</div>';
            
            if (window.L) {
                html += '<div class="status success">';
                html += '<strong>‚úÖ Leaflet Available</strong><br>';
                html += `Version: ${L.version || 'Unknown'}<br>`;
                html += 'Ready to create maps!';
                html += '</div>';
            } else {
                html += '<div class="status error">';
                html += '<strong>‚ùå Leaflet Not Available</strong><br>';
                html += 'This could be the reason maps are not showing.';
                html += '</div>';
            }
            
            diagnostics.innerHTML = html;
        }
        
        function initTestMap() {
            console.log('üó∫Ô∏è Initializing test map...');
            
            if (!window.L) {
                alert('‚ùå Leaflet library not loaded!');
                return;
            }
            
            try {
                // Clear existing map
                if (debugMap) {
                    debugMap.remove();
                }
                
                // Create test map with proper configuration
                debugMap = L.map('debug-map', {
                    center: [-7.898878, 111.961884],
                    zoom: 15,
                    zoomControl: true,
                    attributionControl: true
                });
                
                // Add OpenStreetMap tiles with subdomains
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19,
                    subdomains: ['a', 'b', 'c']
                }).addTo(debugMap);
                
                // Add test marker with custom icon
                const userIcon = L.divIcon({
                    html: `<div class="bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold shadow-lg">üìç</div>`,
                    className: 'custom-div-icon',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });
                
                const marker = L.marker([-7.898878, 111.961884], {
                    icon: userIcon
                }).addTo(debugMap);
                marker.bindPopup('Test Location - Dokterku Clinic<br>Using Paramedis Patterns').openPopup();
                
                console.log('‚úÖ Test map created successfully with paramedis patterns!');
                updateSolutions('‚úÖ Test map works with improved patterns! Doctor map should now work.');
                
            } catch (error) {
                console.error('‚ùå Error creating test map:', error);
                updateSolutions('‚ùå Error: ' + error.message);
            }
        }
        
        function testGPS() {
            console.log('üéØ Testing GPS...');
            
            if (!navigator.geolocation) {
                updateSolutions('‚ùå Geolocation not supported');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    console.log('‚úÖ GPS Success:', { latitude, longitude, accuracy });
                    
                    if (debugMap) {
                        debugMap.setView([latitude, longitude], 17);
                        L.marker([latitude, longitude])
                            .addTo(debugMap)
                            .bindPopup(\`GPS Location<br>Accuracy: \${accuracy.toFixed(1)}m\`)
                            .openPopup();
                    }
                    
                    updateSolutions(\`‚úÖ GPS works! Lat: \${latitude.toFixed(6)}, Lng: \${longitude.toFixed(6)}\`);
                },
                (error) => {
                    console.error('‚ùå GPS Error:', error);
                    updateSolutions('‚ùå GPS Error: ' + error.message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 30000,
                    maximumAge: 0
                }
            );
        }
        
        function updateSolutions(message) {
            const solutions = document.getElementById('solutions');
            const timestamp = new Date().toLocaleTimeString();
            
            solutions.innerHTML += \`
                <div class="status info">
                    [\${timestamp}] \${message}
                </div>
            \`;
        }
        
        // Check if Leaflet loaded properly
        window.addEventListener('load', () => {
            console.log('üîß Page loaded, checking Leaflet...');
            updateDiagnostics();
            
            if (window.L) {
                updateSolutions('‚úÖ Leaflet loaded successfully on page load');
                setTimeout(initTestMap, 1000); // Auto-init after 1 second
            } else {
                updateSolutions('‚ùå Leaflet not loaded - this is likely the problem!');
            }
        });
        
        // Monitor for dynamic Leaflet loading
        let checkCount = 0;
        const checkInterval = setInterval(() => {
            checkCount++;
            if (window.L) {
                updateSolutions(\`‚úÖ Leaflet became available after \${checkCount} checks\`);
                updateDiagnostics();
                clearInterval(checkInterval);
            } else if (checkCount > 10) {
                updateSolutions('‚ùå Leaflet still not available after 10 seconds');
                clearInterval(checkInterval);
            }
        }, 1000);
    </script>
</body>
</html>