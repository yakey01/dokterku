<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê Mobile Login Fix</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
            font-size: 14px;
        }
        .btn.success { background: #10b981; }
        .btn.danger { background: #ef4444; }
        .log {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>üîê Mobile Login Fix for Naning</h1>
    <p><strong>Solution:</strong> Use web-based login instead of API to establish proper session</p>
    
    <div class="test-card">
        <h3>1. Web-Based Login (Proper Session)</h3>
        <form id="webLoginForm" onsubmit="performWebLogin(event)">
            <input type="text" id="username" name="username" value="naning" placeholder="Username" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px;">
            <input type="password" id="password" name="password" value="password123" placeholder="Password" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px;">
            <button type="submit" class="btn success">üîê Login via Web Form</button>
        </form>
        <div id="login-result"></div>
    </div>

    <div class="test-card">
        <h3>2. Test Session After Login</h3>
        <button class="btn" onclick="testCurrentSession()">üîç Check Current Session</button>
        <div id="session-result"></div>
    </div>

    <div class="test-card">
        <h3>3. Test Dashboard Access</h3>
        <button class="btn" onclick="testDashboardAccess()">üìä Test Dashboard Redirect</button>
        <div id="dashboard-result"></div>
    </div>

    <div class="test-card">
        <h3>4. Quick Actions</h3>
        <button class="btn danger" onclick="logout()">üö™ Logout</button>
        <button class="btn success" onclick="goToParamedis()">üì± Go to Paramedis Dashboard</button>
    </div>

    <div class="test-card">
        <h3>üîç Debug Log</h3>
        <button class="btn" onclick="clearLog()">Clear Log</button>
        <div id="debug-log" class="log"></div>
    </div>

    <!-- Hidden iframe for form submission -->
    <iframe id="loginFrame" name="loginFrame" class="hidden"></iframe>

    <script>
        const API_BASE = window.location.origin;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debug-log');
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : 'üîç';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function clearLog() {
            document.getElementById('debug-log').textContent = '';
        }

        async function getCsrfToken() {
            try {
                const response = await fetch(`${API_BASE}/refresh-csrf`);
                const data = await response.json();
                return data.token;
            } catch (e) {
                log('Failed to get CSRF token: ' + e.message, 'error');
                return null;
            }
        }

        async function performWebLogin(event) {
            event.preventDefault();
            log('=== PERFORMING WEB-BASED LOGIN ===');
            
            try {
                // Get CSRF token first
                log('Getting CSRF token...');
                const csrfToken = await getCsrfToken();
                if (!csrfToken) {
                    throw new Error('Failed to get CSRF token');
                }
                log('‚úÖ Got CSRF token');

                // Prepare form data
                const formData = new FormData();
                formData.append('email_or_username', document.getElementById('username').value);
                formData.append('password', document.getElementById('password').value);
                formData.append('_token', csrfToken);

                log('Submitting login form...');
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include',
                    redirect: 'manual'
                });

                log(`Login response status: ${response.status}`);
                
                if (response.status === 302 || response.status === 301) {
                    const location = response.headers.get('Location');
                    log(`‚úÖ Login successful! Redirect to: ${location}`);
                    showResult('login-result', `‚úÖ Login successful! Session established.`, 'success');
                    
                    // Test session immediately
                    setTimeout(() => testCurrentSession(), 500);
                } else if (response.status === 200) {
                    const text = await response.text();
                    if (text.includes('dashboard') || text.includes('paramedis')) {
                        log('‚úÖ Login successful (200 response)');
                        showResult('login-result', '‚úÖ Login successful!', 'success');
                        setTimeout(() => testCurrentSession(), 500);
                    } else {
                        throw new Error('Login failed - check credentials');
                    }
                } else {
                    throw new Error(`Login failed with status: ${response.status}`);
                }

            } catch (error) {
                log(`‚ùå Login error: ${error.message}`, 'error');
                showResult('login-result', `‚ùå Login failed: ${error.message}`, 'error');
            }
        }

        async function testCurrentSession() {
            log('=== TESTING CURRENT SESSION ===');
            
            try {
                const response = await fetch(`${API_BASE}/test-hasrole-debug`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`Session data: ${JSON.stringify(data, null, 2)}`);
                    
                    if (data.user_id) {
                        log(`‚úÖ Authenticated as: ${data.user_name} (ID: ${data.user_id})`);
                        log(`Role: ${data.role_name}`);
                        log(`hasRole('paramedis'): ${data.hasParamedisRole}`);
                        
                        if (data.hasParamedisRole) {
                            showResult('session-result', 
                                `‚úÖ SUCCESS! Logged in as ${data.user_name} with paramedis role`, 
                                'success'
                            );
                        } else {
                            showResult('session-result', 
                                `‚ö†Ô∏è Logged in as ${data.user_name} but role is ${data.role_name}`, 
                                'error'
                            );
                        }
                    } else {
                        throw new Error('No authenticated user in session');
                    }
                } else {
                    throw new Error(`Session check failed: ${response.status}`);
                }

            } catch (error) {
                log(`‚ùå Session test error: ${error.message}`, 'error');
                showResult('session-result', `‚ùå Not authenticated: ${error.message}`, 'error');
            }
        }

        async function testDashboardAccess() {
            log('=== TESTING DASHBOARD ACCESS ===');
            
            try {
                const response = await fetch(`${API_BASE}/dashboard`, {
                    method: 'GET',
                    credentials: 'include',
                    redirect: 'manual'
                });

                log(`Dashboard response: ${response.status}`);
                
                if (response.status === 302 || response.status === 301) {
                    const location = response.headers.get('Location');
                    log(`Dashboard redirects to: ${location}`);
                    
                    if (location && location.includes('paramedis')) {
                        showResult('dashboard-result', `‚úÖ Dashboard correctly redirects to paramedis!`, 'success');
                    } else if (location && location.includes('bendahara')) {
                        showResult('dashboard-result', `‚ùå Still redirecting to bendahara: ${location}`, 'error');
                    } else {
                        showResult('dashboard-result', `‚ö†Ô∏è Dashboard redirects to: ${location}`, 'warning');
                    }
                } else {
                    showResult('dashboard-result', `Dashboard status: ${response.status}`, 'warning');
                }

            } catch (error) {
                log(`‚ùå Dashboard test error: ${error.message}`, 'error');
                showResult('dashboard-result', `‚ùå Dashboard test failed: ${error.message}`, 'error');
            }
        }

        async function logout() {
            log('Logging out...');
            window.location.href = `${API_BASE}/force-logout-all`;
        }

        function goToParamedis() {
            log('Navigating to paramedis dashboard...');
            window.location.href = `${API_BASE}/paramedis`;
        }

        // Auto-initialize
        log('Mobile login fix page loaded');
        log('Ready to test web-based authentication');
    </script>
</body>
</html>