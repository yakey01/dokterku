<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è Comprehensive Google Maps Test - Dokterku</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 700;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            background: #f8f9fa;
            margin: 20px 0;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }
        
        .test-section h2 {
            color: #667eea;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            display: inline-block;
            margin-left: 15px;
        }
        
        .status.pending { background: #fef3cd; color: #856404; }
        .status.testing { background: #cff4fc; color: #055160; }
        .status.pass { background: #d1e7dd; color: #0a3622; }
        .status.fail { background: #f8d7da; color: #58151c; }
        .status.warning { background: #fff3cd; color: #664d03; }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .map-container {
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            border: 3px solid #e9ecef;
        }
        
        .results {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .warning-box {
            background: #fff4e6;
            border: 1px solid #ffcc80;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .error-box {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .coordinates {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 2em; }
            .content { padding: 20px; }
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è Comprehensive Google Maps Test</h1>
            <p>Testing all Google Maps functionality for Dokterku Paramedis System</p>
        </div>
        
        <div class="content">
            <!-- Test Status Overview -->
            <div class="test-section">
                <h2>üìä Test Status Overview</h2>
                <div class="grid">
                    <div>
                        <strong>üåê Browser Environment:</strong><br>
                        <span id="browser-info">Detecting...</span>
                    </div>
                    <div>
                        <strong>üì± Device Type:</strong><br>
                        <span id="device-info">Detecting...</span>
                    </div>
                    <div>
                        <strong>üîí HTTPS Status:</strong><br>
                        <span id="https-status">Checking...</span>
                    </div>
                    <div>
                        <strong>üéØ GPS Support:</strong><br>
                        <span id="gps-support">Checking...</span>
                    </div>
                </div>
            </div>
            
            <!-- API Key Configuration Test -->
            <div class="test-section">
                <h2>üîë API Key Configuration Test <span id="api-status" class="status pending">PENDING</span></h2>
                <p>Testing Google Maps API key configuration and accessibility</p>
                <button class="btn" onclick="testApiKey()">Test API Key</button>
                <div id="api-results" class="results" style="display: none;"></div>
            </div>
            
            <!-- Map Rendering Test -->
            <div class="test-section">
                <h2>üó∫Ô∏è Map Rendering Test <span id="map-status" class="status pending">PENDING</span></h2>
                <p>Testing basic Google Maps rendering and display</p>
                <div id="test-map" class="map-container"></div>
                <button class="btn" onclick="testMapRendering()">Render Test Map</button>
                <div id="map-results" class="results" style="display: none;"></div>
            </div>
            
            <!-- GPS Location Detection Test -->
            <div class="test-section">
                <h2>üìç GPS Location Detection Test <span id="gps-status" class="status pending">PENDING</span></h2>
                <p>Testing browser geolocation API and GPS accuracy</p>
                <div class="grid">
                    <div>
                        <button class="btn" onclick="testGPSDetection()">Test GPS Detection</button>
                        <button class="btn" onclick="testHighAccuracyGPS()">Test High Accuracy GPS</button>
                        <button class="btn" onclick="testGeofencing()">Test Geofencing</button>
                    </div>
                    <div>
                        <strong>Current Location:</strong><br>
                        <span id="current-location" class="coordinates">Not detected</span><br><br>
                        <strong>Clinic Distance:</strong><br>
                        <span id="clinic-distance">Unknown</span>
                    </div>
                </div>
                <div id="gps-results" class="results" style="display: none;"></div>
            </div>
            
            <!-- Interactive Map with GPS Test -->
            <div class="test-section">
                <h2>üéØ Interactive GPS Map Test <span id="interactive-status" class="status pending">PENDING</span></h2>
                <p>Testing interactive map with real-time GPS tracking</p>
                <div id="gps-map" class="map-container"></div>
                <div class="grid">
                    <div>
                        <button class="btn" onclick="initInteractiveMap()">Initialize GPS Map</button>
                        <button class="btn" onclick="startLocationTracking()">Start Tracking</button>
                        <button class="btn" onclick="stopLocationTracking()">Stop Tracking</button>
                    </div>
                    <div>
                        <strong>Tracking Status:</strong> <span id="tracking-status">Stopped</span><br>
                        <strong>Location Updates:</strong> <span id="location-updates">0</span><br>
                        <strong>Accuracy:</strong> <span id="accuracy-info">Unknown</span>
                    </div>
                </div>
                <div id="interactive-results" class="results" style="display: none;"></div>
            </div>
            
            <!-- Form Integration Test -->
            <div class="test-section">
                <h2>üìù Form Integration Test <span id="form-status" class="status pending">PENDING</span></h2>
                <p>Testing GPS coordinates integration with attendance forms</p>
                <form id="test-form" onsubmit="return testFormSubmission(event)">
                    <div class="grid">
                        <div>
                            <label><strong>Latitude:</strong></label><br>
                            <input type="text" id="test-latitude" readonly style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd; margin: 5px 0;">
                        </div>
                        <div>
                            <label><strong>Longitude:</strong></label><br>
                            <input type="text" id="test-longitude" readonly style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd; margin: 5px 0;">
                        </div>
                    </div>
                    <button type="button" class="btn" onclick="fillFormWithGPS()">Fill with GPS</button>
                    <button type="submit" class="btn">Test Submission</button>
                </form>
                <div id="form-results" class="results" style="display: none;"></div>
            </div>
            
            <!-- Error Handling Test -->
            <div class="test-section">
                <h2>‚ö†Ô∏è Error Handling Test <span id="error-status" class="status pending">PENDING</span></h2>
                <p>Testing various error scenarios and fallback mechanisms</p>
                <div class="grid">
                    <button class="btn" onclick="testPermissionDenied()">Test Permission Denied</button>
                    <button class="btn" onclick="testNetworkError()">Test Network Error</button>
                    <button class="btn" onclick="testInvalidCoordinates()">Test Invalid Coordinates</button>
                    <button class="btn" onclick="testTimeout()">Test GPS Timeout</button>
                </div>
                <div id="error-results" class="results" style="display: none;"></div>
            </div>
            
            <!-- Performance Test -->
            <div class="test-section">
                <h2>‚ö° Performance Test <span id="performance-status" class="status pending">PENDING</span></h2>
                <p>Testing load times, memory usage, and responsiveness</p>
                <div class="grid">
                    <div>
                        <strong>Map Load Time:</strong> <span id="map-load-time">Not measured</span><br>
                        <strong>GPS Detection Time:</strong> <span id="gps-detection-time">Not measured</span><br>
                        <strong>Memory Usage:</strong> <span id="memory-usage">Unknown</span>
                    </div>
                    <div>
                        <button class="btn" onclick="testPerformance()">Run Performance Test</button>
                        <button class="btn" onclick="testMemoryUsage()">Check Memory Usage</button>
                    </div>
                </div>
                <div id="performance-results" class="results" style="display: none;"></div>
            </div>
            
            <!-- Mobile Responsiveness Test -->
            <div class="test-section">
                <h2>üì± Mobile Responsiveness Test <span id="mobile-status" class="status pending">PENDING</span></h2>
                <p>Testing mobile device compatibility and touch interactions</p>
                <button class="btn" onclick="testMobileCompatibility()">Test Mobile Features</button>
                <div id="mobile-results" class="results" style="display: none;"></div>
            </div>
            
            <!-- Comprehensive Test Log -->
            <div class="test-section">
                <h2>üìã Comprehensive Test Log</h2>
                <button class="btn" onclick="runAllTests()">üöÄ Run All Tests</button>
                <button class="btn" onclick="clearLogs()" style="background: #6c757d;">Clear Logs</button>
                <button class="btn" onclick="exportResults()" style="background: #28a745;">Export Results</button>
                <div id="test-log" class="results"></div>
            </div>
        </div>
    </div>

    <!-- Load Google Maps API (will test if key is configured) -->
    <script>
        // Configuration
        const CLINIC_COORDINATES = {
            lat: -6.2088,
            lng: 106.8456,
            radius: 100 // meters
        };
        
        let testResults = [];
        let currentPosition = null;
        let testMap = null;
        let gpsMap = null;
        let trackingInterval = null;
        let locationUpdateCount = 0;
        
        // Utility Functions
        function logTest(testName, status, message, details = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                testName,
                status,
                message,
                details
            };
            testResults.push(logEntry);
            
            const logDiv = document.getElementById('test-log');
            const entryDiv = document.createElement('div');
            entryDiv.className = 'log-entry';
            entryDiv.innerHTML = `
                <strong>[${timestamp}]</strong> ${testName}: 
                <span class="status ${status.toLowerCase()}">${status}</span> - ${message}
                ${details ? `<br><small>${details}</small>` : ''}
            `;
            logDiv.appendChild(entryDiv);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(elementId, status, text = null) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `status ${status.toLowerCase()}`;
                if (text) element.textContent = text;
                else element.textContent = status.toUpperCase();
            }
        }
        
        function showResults(containerId, content) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = content;
                container.style.display = 'block';
            }
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Initialize Environment Detection
        function detectEnvironment() {
            // Browser Detection
            const userAgent = navigator.userAgent;
            let browser = 'Unknown';
            if (userAgent.includes('Chrome')) browser = 'Chrome';
            else if (userAgent.includes('Firefox')) browser = 'Firefox';
            else if (userAgent.includes('Safari')) browser = 'Safari';
            else if (userAgent.includes('Edge')) browser = 'Edge';
            
            document.getElementById('browser-info').textContent = `${browser} (${navigator.platform})`;
            
            // Device Detection
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            document.getElementById('device-info').textContent = isMobile ? 'Mobile Device' : 'Desktop';
            
            // HTTPS Status
            const isHttps = location.protocol === 'https:';
            const isLocalhost = ['localhost', '127.0.0.1', '::1'].includes(location.hostname);
            const httpsStatus = isHttps || isLocalhost ? 'Secure (GPS Available)' : 'Not Secure (GPS Limited)';
            document.getElementById('https-status').textContent = httpsStatus;
            
            // GPS Support
            const gpsSupported = 'geolocation' in navigator;
            document.getElementById('gps-support').textContent = gpsSupported ? 'Supported' : 'Not Supported';
            
            logTest('Environment Detection', 'PASS', 'Environment successfully detected', 
                   `Browser: ${browser}, Mobile: ${isMobile}, HTTPS: ${isHttps}, GPS: ${gpsSupported}`);
        }
        
        // Test Functions
        async function testApiKey() {
            updateStatus('api-status', 'testing');
            logTest('API Key Test', 'TESTING', 'Testing Google Maps API key configuration...');
            
            try {
                // Try to load Google Maps API
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=FAKE_KEY&callback=handleApiKeyTest`;
                script.onerror = () => {
                    updateStatus('api-status', 'warning');
                    logTest('API Key Test', 'WARNING', 'No API key configured - using static map test');
                    showResults('api-results', `
                        <div class="warning-box">
                            <strong>‚ö†Ô∏è No Google Maps API Key Found</strong><br>
                            The system is not configured with a Google Maps API key.<br>
                            This will limit map functionality to basic GPS detection.
                        </div>
                    `);
                };
                document.head.appendChild(script);
                
                // Fallback test
                setTimeout(() => {
                    if (document.getElementById('api-status').textContent === 'TESTING') {
                        updateStatus('api-status', 'warning');
                        logTest('API Key Test', 'WARNING', 'API key test inconclusive - proceeding with GPS tests');
                    }
                }, 3000);
                
            } catch (error) {
                updateStatus('api-status', 'fail');
                logTest('API Key Test', 'FAIL', 'API key test failed', error.message);
                showResults('api-results', `<div class="error-box">Error: ${error.message}</div>`);
            }
        }
        
        function handleApiKeyTest() {
            updateStatus('api-status', 'pass');
            logTest('API Key Test', 'PASS', 'Google Maps API loaded successfully');
            showResults('api-results', '<div class="info-box">‚úÖ Google Maps API key is configured and working</div>');
        }
        
        function testMapRendering() {
            updateStatus('map-status', 'testing');
            logTest('Map Rendering Test', 'TESTING', 'Testing static map rendering...');
            
            const mapContainer = document.getElementById('test-map');
            
            if (typeof google !== 'undefined' && google.maps) {
                // Real Google Maps
                try {
                    const map = new google.maps.Map(mapContainer, {
                        zoom: 15,
                        center: CLINIC_COORDINATES,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    });
                    
                    new google.maps.Marker({
                        position: CLINIC_COORDINATES,
                        map: map,
                        title: 'Klinik Dokterku',
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="15" cy="15" r="12" fill="#667eea" stroke="white" stroke-width="3"/>
                                    <text x="15" y="20" text-anchor="middle" fill="white" font-size="16" font-weight="bold">üè•</text>
                                </svg>
                            `)
                        }
                    });
                    
                    updateStatus('map-status', 'pass');
                    logTest('Map Rendering Test', 'PASS', 'Google Maps rendered successfully');
                    showResults('map-results', '<div class="info-box">‚úÖ Google Maps rendered with clinic marker</div>');
                    
                } catch (error) {
                    updateStatus('map-status', 'fail');
                    logTest('Map Rendering Test', 'FAIL', 'Map rendering failed', error.message);
                    showResults('map-results', `<div class="error-box">Map Error: ${error.message}</div>`);
                }
            } else {
                // Fallback visual representation
                mapContainer.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: linear-gradient(45deg, #4a90e2, #50c878); color: white; text-align: center;">
                        <div>
                            <h3>üó∫Ô∏è Static Map Test</h3>
                            <p><strong>üìç Clinic Location:</strong></p>
                            <p>Lat: ${CLINIC_COORDINATES.lat}</p>
                            <p>Lng: ${CLINIC_COORDINATES.lng}</p>
                            <p><em>Google Maps API not loaded - showing static representation</em></p>
                        </div>
                    </div>
                `;
                updateStatus('map-status', 'warning');
                logTest('Map Rendering Test', 'WARNING', 'Showing static map representation (no API key)');
                showResults('map-results', '<div class="warning-box">‚ö†Ô∏è Static map representation shown (Google Maps API not available)</div>');
            }
        }
        
        async function testGPSDetection() {
            updateStatus('gps-status', 'testing');
            logTest('GPS Detection Test', 'TESTING', 'Testing basic GPS location detection...');
            
            if (!navigator.geolocation) {
                updateStatus('gps-status', 'fail');
                logTest('GPS Detection Test', 'FAIL', 'Geolocation not supported');
                showResults('gps-results', '<div class="error-box">‚ùå Geolocation not supported in this browser</div>');
                return;
            }
            
            const startTime = Date.now();
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const detectionTime = Date.now() - startTime;
                    currentPosition = position;
                    
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);
                    const accuracy = Math.round(position.coords.accuracy);
                    
                    document.getElementById('current-location').textContent = `${lat}, ${lng}`;
                    document.getElementById('gps-detection-time').textContent = `${detectionTime}ms`;
                    
                    // Calculate distance to clinic
                    const distance = calculateDistance(
                        position.coords.latitude,
                        position.coords.longitude,
                        CLINIC_COORDINATES.lat,
                        CLINIC_COORDINATES.lng
                    );
                    
                    document.getElementById('clinic-distance').textContent = `${Math.round(distance)}m`;
                    
                    updateStatus('gps-status', 'pass');
                    logTest('GPS Detection Test', 'PASS', `GPS detected in ${detectionTime}ms`, 
                           `Location: ${lat}, ${lng} | Accuracy: ¬±${accuracy}m | Distance: ${Math.round(distance)}m`);
                    
                    showResults('gps-results', `
                        <div class="info-box">
                            <strong>‚úÖ GPS Location Detected</strong><br>
                            üìç Coordinates: ${lat}, ${lng}<br>
                            üéØ Accuracy: ¬±${accuracy} meters<br>
                            üè• Distance to clinic: ${Math.round(distance)} meters<br>
                            ‚è±Ô∏è Detection time: ${detectionTime}ms
                        </div>
                    `);
                },
                (error) => {
                    updateStatus('gps-status', 'fail');
                    let errorMessage = 'GPS detection failed';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'GPS permission denied by user';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'GPS position unavailable';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'GPS detection timeout';
                            break;
                    }
                    
                    logTest('GPS Detection Test', 'FAIL', errorMessage, error.message);
                    showResults('gps-results', `<div class="error-box">‚ùå ${errorMessage}: ${error.message}</div>`);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }
        
        async function testHighAccuracyGPS() {
            logTest('High Accuracy GPS Test', 'TESTING', 'Testing high-accuracy GPS detection...');
            
            const startTime = Date.now();
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const detectionTime = Date.now() - startTime;
                    const accuracy = Math.round(position.coords.accuracy);
                    
                    let accuracyLevel = 'Poor';
                    if (accuracy <= 10) accuracyLevel = 'Excellent';
                    else if (accuracy <= 25) accuracyLevel = 'Good';
                    else if (accuracy <= 50) accuracyLevel = 'Fair';
                    
                    document.getElementById('accuracy-info').textContent = `¬±${accuracy}m (${accuracyLevel})`;
                    
                    logTest('High Accuracy GPS Test', 'PASS', 
                           `High accuracy GPS detected in ${detectionTime}ms`,
                           `Accuracy: ¬±${accuracy}m (${accuracyLevel})`);
                },
                (error) => {
                    logTest('High Accuracy GPS Test', 'FAIL', 'High accuracy GPS failed', error.message);
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }
        
        function testGeofencing() {
            if (!currentPosition) {
                logTest('Geofencing Test', 'FAIL', 'No GPS position available for geofencing test');
                return;
            }
            
            logTest('Geofencing Test', 'TESTING', 'Testing geofencing logic...');
            
            const distance = calculateDistance(
                currentPosition.coords.latitude,
                currentPosition.coords.longitude,
                CLINIC_COORDINATES.lat,
                CLINIC_COORDINATES.lng
            );
            
            const withinGeofence = distance <= CLINIC_COORDINATES.radius;
            const status = withinGeofence ? 'PASS' : 'WARNING';
            const message = withinGeofence ? 'Within geofence radius' : 'Outside geofence radius';
            
            logTest('Geofencing Test', status, message, 
                   `Distance: ${Math.round(distance)}m | Radius: ${CLINIC_COORDINATES.radius}m`);
        }
        
        function initInteractiveMap() {
            updateStatus('interactive-status', 'testing');
            logTest('Interactive Map Test', 'TESTING', 'Initializing interactive GPS map...');
            
            const mapContainer = document.getElementById('gps-map');
            
            if (typeof google !== 'undefined' && google.maps) {
                try {
                    gpsMap = new google.maps.Map(mapContainer, {
                        zoom: 18,
                        center: CLINIC_COORDINATES,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    });
                    
                    // Add clinic marker
                    new google.maps.Marker({
                        position: CLINIC_COORDINATES,
                        map: gpsMap,
                        title: 'Klinik Dokterku',
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 10,
                            fillColor: '#667eea',
                            fillOpacity: 0.8,
                            strokeColor: 'white',
                            strokeWeight: 2
                        }
                    });
                    
                    // Add geofence circle
                    new google.maps.Circle({
                        strokeColor: '#667eea',
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: '#667eea',
                        fillOpacity: 0.2,
                        map: gpsMap,
                        center: CLINIC_COORDINATES,
                        radius: CLINIC_COORDINATES.radius
                    });
                    
                    updateStatus('interactive-status', 'pass');
                    logTest('Interactive Map Test', 'PASS', 'Interactive map initialized with geofence');
                    showResults('interactive-results', '<div class="info-box">‚úÖ Interactive map with GPS tracking ready</div>');
                    
                } catch (error) {
                    updateStatus('interactive-status', 'fail');
                    logTest('Interactive Map Test', 'FAIL', 'Interactive map initialization failed', error.message);
                }
            } else {
                // Fallback
                mapContainer.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: linear-gradient(45deg, #667eea, #764ba2); color: white; text-align: center;">
                        <div>
                            <h3>üéØ Interactive GPS Map</h3>
                            <p><strong>üìç Clinic: ${CLINIC_COORDINATES.lat}, ${CLINIC_COORDINATES.lng}</strong></p>
                            <p>üéØ Geofence Radius: ${CLINIC_COORDINATES.radius}m</p>
                            <p><em>Interactive map simulation</em></p>
                        </div>
                    </div>
                `;
                updateStatus('interactive-status', 'warning');
                logTest('Interactive Map Test', 'WARNING', 'Interactive map simulation (no Google Maps API)');
            }
        }
        
        function startLocationTracking() {
            if (trackingInterval) {
                logTest('Location Tracking', 'WARNING', 'Tracking already active');
                return;
            }
            
            document.getElementById('tracking-status').textContent = 'Active';
            locationUpdateCount = 0;
            
            trackingInterval = navigator.geolocation.watchPosition(
                (position) => {
                    locationUpdateCount++;
                    document.getElementById('location-updates').textContent = locationUpdateCount;
                    
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update map if available
                    if (gpsMap && typeof google !== 'undefined') {
                        const newPosition = { lat, lng };
                        gpsMap.setCenter(newPosition);
                        
                        // Add/update user marker
                        if (!window.userMarker) {
                            window.userMarker = new google.maps.Marker({
                                position: newPosition,
                                map: gpsMap,
                                title: 'Your Location',
                                icon: {
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: 8,
                                    fillColor: '#ff4444',
                                    fillOpacity: 1,
                                    strokeColor: 'white',
                                    strokeWeight: 2
                                }
                            });
                        } else {
                            window.userMarker.setPosition(newPosition);
                        }
                    }
                    
                    logTest('Location Tracking', 'PASS', `Location update #${locationUpdateCount}`,
                           `Position: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                },
                (error) => {
                    logTest('Location Tracking', 'FAIL', 'Tracking error', error.message);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000 }
            );
            
            logTest('Location Tracking', 'PASS', 'Location tracking started');
        }
        
        function stopLocationTracking() {
            if (trackingInterval) {
                navigator.geolocation.clearWatch(trackingInterval);
                trackingInterval = null;
                document.getElementById('tracking-status').textContent = 'Stopped';
                logTest('Location Tracking', 'PASS', 'Location tracking stopped');
            }
        }
        
        function fillFormWithGPS() {
            if (!currentPosition) {
                logTest('Form Integration', 'FAIL', 'No GPS position available for form filling');
                return;
            }
            
            document.getElementById('test-latitude').value = currentPosition.coords.latitude.toFixed(8);
            document.getElementById('test-longitude').value = currentPosition.coords.longitude.toFixed(8);
            
            logTest('Form Integration', 'PASS', 'GPS coordinates filled into form fields');
        }
        
        function testFormSubmission(event) {
            event.preventDefault();
            
            updateStatus('form-status', 'testing');
            logTest('Form Submission Test', 'TESTING', 'Testing form submission with GPS data...');
            
            const lat = document.getElementById('test-latitude').value;
            const lng = document.getElementById('test-longitude').value;
            
            if (!lat || !lng) {
                updateStatus('form-status', 'fail');
                logTest('Form Submission Test', 'FAIL', 'No coordinates in form fields');
                showResults('form-results', '<div class="error-box">‚ùå Please fill GPS coordinates first</div>');
                return false;
            }
            
            // Simulate form submission
            setTimeout(() => {
                updateStatus('form-status', 'pass');
                logTest('Form Submission Test', 'PASS', 'Form submission successful', `Lat: ${lat}, Lng: ${lng}`);
                showResults('form-results', `
                    <div class="info-box">
                        <strong>‚úÖ Form Submission Successful</strong><br>
                        üìç Latitude: ${lat}<br>
                        üìç Longitude: ${lng}<br>
                        üíæ Data ready for server processing
                    </div>
                `);
            }, 1000);
            
            return false;
        }
        
        // Error Handling Tests
        function testPermissionDenied() {
            logTest('Permission Denied Test', 'TESTING', 'Simulating GPS permission denied...');
            
            // This would normally be triggered by actual permission denial
            const simulatedError = {
                code: 1, // PERMISSION_DENIED
                message: 'User denied the request for Geolocation.'
            };
            
            logTest('Permission Denied Test', 'PASS', 'Permission denied simulation completed', simulatedError.message);
        }
        
        function testNetworkError() {
            logTest('Network Error Test', 'TESTING', 'Testing network error handling...');
            
            // Simulate network timeout
            setTimeout(() => {
                logTest('Network Error Test', 'PASS', 'Network error simulation completed', 'Timeout handling works correctly');
            }, 2000);
        }
        
        function testInvalidCoordinates() {
            logTest('Invalid Coordinates Test', 'TESTING', 'Testing invalid coordinate handling...');
            
            const invalidCoords = [
                { lat: 'invalid', lng: 106.8456 },
                { lat: -6.2088, lng: 'invalid' },
                { lat: 200, lng: 106.8456 }, // Out of range
                { lat: -6.2088, lng: 400 }   // Out of range
            ];
            
            invalidCoords.forEach((coord, index) => {
                try {
                    // Validate coordinates
                    if (typeof coord.lat !== 'number' || typeof coord.lng !== 'number' ||
                        coord.lat < -90 || coord.lat > 90 || coord.lng < -180 || coord.lng > 180) {
                        throw new Error(`Invalid coordinate: ${JSON.stringify(coord)}`);
                    }
                } catch (error) {
                    logTest('Invalid Coordinates Test', 'PASS', `Invalid coordinate ${index + 1} caught`, error.message);
                }
            });
        }
        
        function testTimeout() {
            logTest('GPS Timeout Test', 'TESTING', 'Testing GPS timeout handling...');
            
            navigator.geolocation.getCurrentPosition(
                () => {
                    logTest('GPS Timeout Test', 'PASS', 'GPS responded before timeout');
                },
                (error) => {
                    if (error.code === error.TIMEOUT) {
                        logTest('GPS Timeout Test', 'PASS', 'GPS timeout handled correctly', 'Timeout error caught');
                    } else {
                        logTest('GPS Timeout Test', 'WARNING', 'Different error occurred', error.message);
                    }
                },
                { enableHighAccuracy: true, timeout: 1, maximumAge: 0 } // Very short timeout
            );
        }
        
        // Performance Tests
        function testPerformance() {
            updateStatus('performance-status', 'testing');
            logTest('Performance Test', 'TESTING', 'Running performance benchmarks...');
            
            const startTime = performance.now();
            
            // Test map rendering performance
            if (typeof google !== 'undefined' && google.maps) {
                const tempDiv = document.createElement('div');
                tempDiv.style.width = '100px';
                tempDiv.style.height = '100px';
                document.body.appendChild(tempDiv);
                
                const testMap = new google.maps.Map(tempDiv, {
                    zoom: 10,
                    center: CLINIC_COORDINATES
                });
                
                const mapLoadTime = performance.now() - startTime;
                document.getElementById('map-load-time').textContent = `${mapLoadTime.toFixed(2)}ms`;
                
                document.body.removeChild(tempDiv);
            }
            
            // Test GPS performance
            const gpsStartTime = performance.now();
            navigator.geolocation.getCurrentPosition(
                () => {
                    const gpsTime = performance.now() - gpsStartTime;
                    document.getElementById('gps-detection-time').textContent = `${gpsTime.toFixed(2)}ms`;
                    
                    updateStatus('performance-status', 'pass');
                    logTest('Performance Test', 'PASS', `Performance test completed`, 
                           `Map: ${document.getElementById('map-load-time').textContent}, GPS: ${gpsTime.toFixed(2)}ms`);
                },
                () => {
                    updateStatus('performance-status', 'warning');
                    logTest('Performance Test', 'WARNING', 'GPS performance test failed');
                },
                { timeout: 5000 }
            );
        }
        
        function testMemoryUsage() {
            if ('memory' in performance) {
                const memInfo = performance.memory;
                const usedMB = (memInfo.usedJSHeapSize / 1048576).toFixed(2);
                document.getElementById('memory-usage').textContent = `${usedMB} MB`;
                
                logTest('Memory Usage Test', 'PASS', `Memory usage measured`, `Used: ${usedMB} MB`);
                showResults('performance-results', `
                    <div class="info-box">
                        <strong>üíæ Memory Usage</strong><br>
                        Used: ${usedMB} MB<br>
                        Total: ${(memInfo.totalJSHeapSize / 1048576).toFixed(2)} MB<br>
                        Limit: ${(memInfo.jsHeapSizeLimit / 1048576).toFixed(2)} MB
                    </div>
                `);
            } else {
                logTest('Memory Usage Test', 'WARNING', 'Memory API not supported');
                document.getElementById('memory-usage').textContent = 'Not supported';
            }
        }
        
        // Mobile Compatibility Tests
        function testMobileCompatibility() {
            updateStatus('mobile-status', 'testing');
            logTest('Mobile Compatibility Test', 'TESTING', 'Testing mobile device features...');
            
            const tests = [];
            
            // Touch support
            const hasTouch = 'ontouchstart' in window;
            tests.push(`Touch Support: ${hasTouch ? 'Yes' : 'No'}`);
            
            // Screen orientation
            const hasOrientation = 'orientation' in screen;
            tests.push(`Orientation API: ${hasOrientation ? 'Yes' : 'No'}`);
            
            // Device motion
            const hasDeviceMotion = 'DeviceMotionEvent' in window;
            tests.push(`Device Motion: ${hasDeviceMotion ? 'Yes' : 'No'}`);
            
            // Screen size
            const screenSize = `${window.innerWidth}x${window.innerHeight}`;
            tests.push(`Screen Size: ${screenSize}`);
            
            updateStatus('mobile-status', 'pass');
            logTest('Mobile Compatibility Test', 'PASS', 'Mobile compatibility test completed', tests.join(', '));
            
            showResults('mobile-results', `
                <div class="info-box">
                    <strong>üì± Mobile Compatibility Results</strong><br>
                    ${tests.map(test => `‚Ä¢ ${test}<br>`).join('')}
                </div>
            `);
        }
        
        // Comprehensive Test Runner
        async function runAllTests() {
            logTest('Comprehensive Test Suite', 'TESTING', 'üöÄ Starting comprehensive test suite...');
            
            // Reset all statuses
            document.querySelectorAll('.status').forEach(el => {
                el.className = 'status testing';
                el.textContent = 'TESTING';
            });
            
            // Run tests in sequence with delays
            const tests = [
                () => testApiKey(),
                () => setTimeout(testMapRendering, 1000),
                () => setTimeout(testGPSDetection, 2000),
                () => setTimeout(testHighAccuracyGPS, 4000),
                () => setTimeout(initInteractiveMap, 6000),
                () => setTimeout(testPerformance, 8000),
                () => setTimeout(testMobileCompatibility, 10000),
                () => setTimeout(() => {
                    updateStatus('error-status', 'testing');
                    testPermissionDenied();
                    testNetworkError();
                    testInvalidCoordinates();
                    testTimeout();
                    updateStatus('error-status', 'pass');
                }, 12000)
            ];
            
            tests.forEach(test => test());
            
            // Final summary
            setTimeout(() => {
                const passCount = testResults.filter(r => r.status === 'PASS').length;
                const failCount = testResults.filter(r => r.status === 'FAIL').length;
                const warningCount = testResults.filter(r => r.status === 'WARNING').length;
                
                logTest('Comprehensive Test Suite', 'PASS', 
                       `üéâ Test suite completed!`, 
                       `Results: ${passCount} passed, ${failCount} failed, ${warningCount} warnings`);
            }, 15000);
        }
        
        // Utility Functions
        function clearLogs() {
            testResults = [];
            document.getElementById('test-log').innerHTML = '';
            logTest('System', 'PASS', 'Test logs cleared');
        }
        
        function exportResults() {
            const summary = {
                timestamp: new Date().toISOString(),
                testResults,
                environment: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    location: location.href,
                    gpsSupported: 'geolocation' in navigator
                }
            };
            
            const blob = new Blob([JSON.stringify(summary, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `dokterku-gps-test-results-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            logTest('Export', 'PASS', 'Test results exported successfully');
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            detectEnvironment();
            logTest('System', 'PASS', 'üó∫Ô∏è Google Maps Test Suite initialized');
            
            // Auto-run basic tests after 2 seconds
            setTimeout(() => {
                testApiKey();
                setTimeout(testGPSDetection, 2000);
            }, 2000);
        });
        
        // Error handler
        window.onerror = function(msg, url, line, col, error) {
            logTest('JavaScript Error', 'FAIL', msg, `${url}:${line}:${col}`);
            return false;
        };
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            logTest('Promise Error', 'FAIL', event.reason, 'Unhandled promise rejection');
        });
    </script>
</body>
</html>