<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Mission Central - Yaya's Schedule</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #333; border-radius: 8px; }
        .success { background: #1a4d3a; border-color: #22c55e; }
        .error { background: #4d1a1a; border-color: #ef4444; }
        .info { background: #1a3a4d; border-color: #3b82f6; }
        button { margin: 5px; padding: 12px 20px; cursor: pointer; border-radius: 6px; border: none; font-weight: bold; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #22c55e; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        pre { background: #2a2a2a; padding: 15px; overflow: auto; max-height: 400px; border-radius: 6px; font-size: 12px; }
        .step { margin: 15px 0; padding: 15px; background: #2a2a2a; border-radius: 6px; }
        .step h3 { margin-top: 0; color: #3b82f6; }
        .status { font-weight: bold; padding: 4px 8px; border-radius: 4px; }
        .status.pending { background: #f59e0b; color: white; }
        .status.testing { background: #3b82f6; color: white; }
        .status.passed { background: #22c55e; color: white; }
        .status.failed { background: #ef4444; color: white; }
    </style>
</head>
<body>
    <h1>üéØ Mission Central Verification - Doctor Yaya</h1>
    <p>Complete end-to-end test to verify Mission Central shows Yaya's specific 17 jadwal missions</p>
    
    <div class="section info">
        <h3>Test Objective</h3>
        <p>Verify that when Dr. Yaya logs in, the Mission Central interface displays her specific 17 jadwal missions instead of generic demo data.</p>
        <ul>
            <li>Expected: 17 missions total</li>
            <li>Expected: 11 completed shifts, 13 upcoming shifts</li>
            <li>Expected: 136 total working hours</li>
            <li>Expected: Real jadwal data from database</li>
        </ul>
    </div>

    <div class="step">
        <h3>Step 1: Create Authentication Token</h3>
        <div>Status: <span class="status pending" id="step1-status">Pending</span></div>
        <button class="btn-primary" onclick="createAuthToken()">üîê Create Token for Yaya</button>
        <div id="step1-result"></div>
    </div>

    <div class="step">
        <h3>Step 2: Test API Endpoint</h3>
        <div>Status: <span class="status pending" id="step2-status">Pending</span></div>
        <button class="btn-primary" onclick="testJadwalAPI()" disabled id="step2-btn">üì° Test Jadwal API</button>
        <div id="step2-result"></div>
    </div>

    <div class="step">
        <h3>Step 3: Store Token & Load Mission Central</h3>
        <div>Status: <span class="status pending" id="step3-status">Pending</span></div>
        <button class="btn-success" onclick="loadMissionCentral()" disabled id="step3-btn">üöÄ Open Mission Central</button>
        <div id="step3-result"></div>
    </div>

    <div class="step">
        <h3>Step 4: Manual Verification</h3>
        <div>Status: <span class="status pending" id="step4-status">Manual Check Required</span></div>
        <p>After opening Mission Central, verify:</p>
        <ul>
            <li>‚úÖ Mission Central loads without errors</li>
            <li>‚úÖ Shows "17" in Total Jaga counter</li>
            <li>‚úÖ Shows "11" in Selesai counter</li>
            <li>‚úÖ Shows "13" in Mendatang counter</li>
            <li>‚úÖ Shows "136" in Jam Kerja counter</li>
            <li>‚úÖ Mission cards show real jadwal data (not demo data)</li>
            <li>‚úÖ Mission details are specific to Dr. Yaya</li>
        </ul>
        <button class="btn-success" onclick="markVerificationComplete()">‚úÖ Mark as Verified</button>
    </div>

    <div class="section" id="summary" style="display: none;">
        <h3>üéâ Test Summary</h3>
        <div id="summary-content"></div>
    </div>

    <script>
        let authToken = null;
        let apiData = null;
        
        async function createAuthToken() {
            const statusEl = document.getElementById('step1-status');
            const resultEl = document.getElementById('step1-result');
            
            statusEl.textContent = 'Testing';
            statusEl.className = 'status testing';
            
            try {
                const response = await fetch('/api/v2/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        login: 'yaya@dokter.local',
                        password: 'password',
                        device_id: 'mission-central-verification-' + Date.now(),
                        device_name: 'Mission Central Verification'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data.authentication.access_token) {
                    authToken = result.data.authentication.access_token;
                    statusEl.textContent = 'Passed';
                    statusEl.className = 'status passed';
                    
                    resultEl.innerHTML = `
                        <div class="success">
                            <p>‚úÖ Authentication successful!</p>
                            <p><strong>User:</strong> ${result.data.user.name} (${result.data.user.email})</p>
                            <p><strong>Token:</strong> ${authToken.substring(0, 20)}... (Length: ${authToken.length} chars)</p>
                            <details style="margin-top: 10px;">
                                <summary style="cursor: pointer; color: #60a5fa;">Show Complete Token</summary>
                                <code style="word-break: break-all; font-size: 11px; background: #374151; padding: 8px; border-radius: 4px; display: block; margin-top: 5px;">
                                    ${authToken}
                                </code>
                            </details>
                        </div>
                    `;
                    
                    // Enable next step
                    document.getElementById('step2-btn').disabled = false;
                } else {
                    throw new Error(result.message || 'Login failed');
                }
            } catch (error) {
                statusEl.textContent = 'Failed';
                statusEl.className = 'status failed';
                resultEl.innerHTML = `
                    <div class="error">
                        <p>‚ùå Authentication failed: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function testJadwalAPI() {
            const statusEl = document.getElementById('step2-status');
            const resultEl = document.getElementById('step2-result');
            
            statusEl.textContent = 'Testing';
            statusEl.className = 'status testing';
            
            try {
                const response = await fetch('/dokter/web-api/jadwal-jaga', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const result = await response.json();
                apiData = result;
                
                if (result.success && result.data) {
                    const { missions, total_shifts, completed_shifts, upcoming_shifts, total_hours } = result.data;
                    
                    // Verify expected values
                    const expectedMissions = 17;
                    const expectedCompleted = 11;
                    const expectedUpcoming = 13;
                    const expectedHours = 136;
                    
                    const missionsMatch = missions.length === expectedMissions;
                    const completedMatch = completed_shifts === expectedCompleted;
                    const upcomingMatch = upcoming_shifts === expectedUpcoming;
                    const hoursMatch = total_hours === expectedHours;
                    
                    const allMatch = missionsMatch && completedMatch && upcomingMatch && hoursMatch;
                    
                    if (allMatch) {
                        statusEl.textContent = 'Passed';
                        statusEl.className = 'status passed';
                        
                        resultEl.innerHTML = `
                            <div class="success">
                                <p>‚úÖ API returns correct Yaya-specific data!</p>
                                <p><strong>Missions:</strong> ${missions.length} (Expected: ${expectedMissions}) ‚úÖ</p>
                                <p><strong>Completed:</strong> ${completed_shifts} (Expected: ${expectedCompleted}) ‚úÖ</p>
                                <p><strong>Upcoming:</strong> ${upcoming_shifts} (Expected: ${expectedUpcoming}) ‚úÖ</p>
                                <p><strong>Total Hours:</strong> ${total_hours} (Expected: ${expectedHours}) ‚úÖ</p>
                                <details>
                                    <summary>Sample Mission Data</summary>
                                    <pre>${JSON.stringify(missions[0], null, 2)}</pre>
                                </details>
                            </div>
                        `;
                        
                        // Enable next step
                        document.getElementById('step3-btn').disabled = false;
                    } else {
                        throw new Error(`Data mismatch: Missions=${missions.length}/${expectedMissions}, Completed=${completed_shifts}/${expectedCompleted}, Upcoming=${upcoming_shifts}/${expectedUpcoming}, Hours=${total_hours}/${expectedHours}`);
                    }
                } else {
                    throw new Error(result.message || 'API call failed');
                }
            } catch (error) {
                statusEl.textContent = 'Failed';
                statusEl.className = 'status failed';
                resultEl.innerHTML = `
                    <div class="error">
                        <p>‚ùå API test failed: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function loadMissionCentral() {
            const statusEl = document.getElementById('step3-status');
            const resultEl = document.getElementById('step3-result');
            
            // Store token in localStorage for Mission Central to use
            localStorage.setItem('dokterku_auth_token', authToken);
            localStorage.setItem('dokterku_user_data', JSON.stringify({
                email: 'yaya@dokter.local',
                name: 'dr Yaya Mulyana, M.Kes',
                authenticated: true
            }));
            
            statusEl.textContent = 'Passed';
            statusEl.className = 'status passed';
            
            resultEl.innerHTML = `
                <div class="success">
                    <p>‚úÖ Token stored in localStorage</p>
                    <p><strong>Opening Mission Central...</strong></p>
                    <button class="btn-warning" onclick="window.open('/dokter/mobile-app', '_blank')">
                        üéØ Open Mission Central in New Tab
                    </button>
                </div>
            `;
            
            // Auto-open Mission Central
            window.open('/dokter/mobile-app', '_blank');
        }
        
        function markVerificationComplete() {
            const statusEl = document.getElementById('step4-status');
            statusEl.textContent = 'Passed';
            statusEl.className = 'status passed';
            
            // Show summary
            const summaryEl = document.getElementById('summary');
            const contentEl = document.getElementById('summary-content');
            
            contentEl.innerHTML = `
                <div class="success">
                    <h4>‚úÖ Mission Central Verification Complete!</h4>
                    <p>Dr. Yaya's Mission Central successfully displays user-specific data:</p>
                    <ul>
                        <li>‚úÖ Authentication working correctly</li>
                        <li>‚úÖ API returns 17 missions specific to Yaya</li>
                        <li>‚úÖ Database relations fixed (using pegawai.id instead of user.id)</li>
                        <li>‚úÖ Mission Central interface loads with real data</li>
                        <li>‚úÖ No more generic demo data displayed</li>
                    </ul>
                    <p><strong>Issue Resolution:</strong> The problem was in DokterDashboardController.php where JadwalJaga queries were using $user->id instead of $pegawai->id for the foreign key relationship.</p>
                </div>
            `;
            
            summaryEl.style.display = 'block';
        }
    </script>
</body>
</html>