document.addEventListener("DOMContentLoaded",function(){console.log("GPS Attendance module loaded"),setTimeout(function(){g()},1e3)});function g(){m(),navigator.geolocation&&h()}function m(){document.querySelectorAll('[data-field-wrapper="location"], [data-field-wrapper="checkout_location"]').forEach(o=>{const t=o.getAttribute("data-field-wrapper");if(o.querySelector(".gps-detect-btn"))return;const e=document.createElement("button");e.type="button",e.className="gps-detect-btn inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 mb-2",e.innerHTML=`
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            Deteksi Lokasi Otomatis
        `,e.addEventListener("click",function(){p(t)});const n=o.querySelector(".filament-google-maps-field");n&&n.parentNode.insertBefore(e,n)})}function h(){var t;if(!navigator.geolocation){console.log("Geolocation not supported");return}const i=window.location.pathname.includes("/create"),o=(t=document.querySelector('input[name="latitude"]'))==null?void 0:t.value;!i||o||navigator.geolocation.getCurrentPosition(function(e){const n=e.coords.latitude,a=e.coords.longitude,c=e.coords.accuracy;console.log("Auto-detected location:",n,a,"Accuracy:",c),u("location",n,a,c),r("success","Lokasi berhasil dideteksi otomatis")},function(e){console.log("Auto-detection failed:",e.message)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})}function p(i){if(!navigator.geolocation){r("error","GPS tidak didukung oleh browser Anda");return}const o=document.querySelector(`[data-field-wrapper="${i}"] .gps-detect-btn`);o&&(o.disabled=!0,o.innerHTML=`
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Mendeteksi...
        `),navigator.geolocation.getCurrentPosition(function(t){const e=t.coords.latitude,n=t.coords.longitude,a=t.coords.accuracy;console.log(`Location detected for ${i}:`,e,n,"Accuracy:",a),u(i,e,n,a),r("success",`Lokasi berhasil dideteksi! Akurasi: ${Math.round(a)} meter`),o&&(o.disabled=!1,o.innerHTML=`
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Deteksi Lokasi Otomatis
                `)},function(t){console.error(`Location detection failed for ${i}:`,t);let e;switch(t.code){case t.PERMISSION_DENIED:e="Akses lokasi ditolak. Mohon izinkan akses lokasi pada browser.";break;case t.POSITION_UNAVAILABLE:e="Informasi lokasi tidak tersedia.";break;case t.TIMEOUT:e="Permintaan lokasi timeout. Silakan coba lagi.";break;default:e="Terjadi kesalahan saat mendeteksi lokasi.";break}r("error",e),o&&(o.disabled=!1,o.innerHTML=`
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Deteksi Lokasi Otomatis
                `)},{enableHighAccuracy:!0,timeout:15e3,maximumAge:3e4})}function u(i,o,t,e){let n,a,c;i==="checkout_location"?(n="checkout_latitude",a="checkout_longitude",c="checkout_accuracy"):(n="latitude",a="longitude",c="accuracy");const s=document.querySelector(`input[name="${n}"]`);s&&(s.value=o.toFixed(8),s.dispatchEvent(new Event("input",{bubbles:!0})));const l=document.querySelector(`input[name="${a}"]`);l&&(l.value=t.toFixed(8),l.dispatchEvent(new Event("input",{bubbles:!0})));const d=document.querySelector(`input[name="${c}"]`);d&&e&&(d.value=Math.round(e),d.dispatchEvent(new Event("input",{bubbles:!0}))),k(i,o,t),f(o,t,i)}function k(i,o,t){setTimeout(()=>{if(window.google&&window.google.maps){const e=document.querySelector(`[data-field-wrapper="${i}"] .google-map`);if(e&&e.googleMap){const n=new google.maps.LatLng(o,t);e.googleMap.setCenter(n),e.marker?e.marker.setPosition(n):e.marker=new google.maps.Marker({position:n,map:e.googleMap,title:"Lokasi Terpilih"})}}},500)}function f(i,o,t){const e=`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${i}&longitude=${o}&localityLanguage=id`;fetch(e).then(n=>n.json()).then(n=>{if(n&&n.displayName){let a;t==="checkout_location"?a="location_name_out":a="location_name_in";const c=document.querySelector(`input[name="${a}"]`);c&&(c.value=n.displayName,c.dispatchEvent(new Event("input",{bubbles:!0})))}}).catch(n=>{console.log("Reverse geocoding failed:",n)})}function r(i,o){const t=document.createElement("div");t.className=`fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${i==="success"?"bg-green-500 text-white":"bg-red-500 text-white"}`,t.innerHTML=`
        <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${i==="success"?'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>':'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'}
            </svg>
            <span>${o}</span>
        </div>
    `,document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},5e3)}window.ParamedisGpsAttendance={detectLocationForField:p,setLocationInForm:u,showLocationNotification:r};
